@inject NavigationManager NavigationManager
@inject IAuthenticationService AuthService
@using Microsoft.AspNetCore.Components.Routing
@using TravelOperation.Core.Services
@implements IDisposable

<div class="w-72 text-white shadow-lg flex flex-col"
     style="background: linear-gradient(180deg, rgb(5, 39, 103) 0%, #3a0647 70%) fixed;
            color: white !important;
            height: 100vh;
            overflow-y: auto;">

    <div class="p-4 flex-shrink-0">
        <a href="/" class="text-2xl font-bold block mb-4 text-center link link-hover" style="color: white !important;">
            ✈️ Travel Expense
        </a>
    </div>

    <ul class="menu p-4 space-y-1 text-sm flex-1"
        style="color: white !important; background: transparent !important;">
        @if (menuItems != null)
        {
            @foreach (var item in menuItems)
            {
                @if (item.IsSection)
                {
                    <li class="menu-title text-xs font-semibold mt-4 mb-2"
                        style="color: rgba(255, 255, 255, 0.7);">
                        <span>@item.Label</span>
                    </li>
                }
                else
                {
                    var isCurrentLocation = IsCurrentLocation(item.Href);
                    var menuItemClass = $"menu-item {(isCurrentLocation ? "active" : "")}";
                    var linkClass = $"flex items-center space-x-3 rounded-lg text-sm py-2 transition-colors duration-200 {(isCurrentLocation ? "active" : "")}";
                    var linkStyle = isCurrentLocation
                    ? "color: white; background-color: rgba(255, 255, 255, 0.2);"
                    : "color: rgba(255, 255, 255, 0.9);";

                    <li class="@menuItemClass">
                        <NavLink href="@item.Href" Match="NavLinkMatch.Prefix"
                                 class="@linkClass"
                                 style="@linkStyle"
                                 ActiveClass="active"
                                 @onclick="@(() => HandleNavClick(item.Href))">
                            <span class="text-lg w-5 text-center">@item.Icon</span>
                            <span style="color: inherit;">@item.Label</span>
                        </NavLink>
                    </li>
                }
            }
        }
        else
        {
            <li class="menu-title text-xs font-semibold mt-4 mb-2" style="color: rgba(255, 255, 255, 0.7);">
                <span>Loading...</span>
            </li>
        }
    </ul>
</div>

@code {
    private string currentLocation = "";
    private IEnumerable<NavMenuItem>? menuItems;
    
    protected override async Task OnInitializedAsync()
    {
        NavigationManager.LocationChanged += OnLocationChanged;
        currentLocation = NavigationManager.Uri;
        
        // Load menu items based on authenticated user role
        await LoadMenuItems();
    }

    private async Task LoadMenuItems()
    {
        try
        {
            // Check if user is authenticated first
            var isAuthenticated = await AuthService.IsAuthenticatedAsync();
            if (isAuthenticated)
            {
                menuItems = await GetMenuItemsForCurrentUserAsync();
            }
            else
            {
                menuItems = new List<NavMenuItem>();
            }
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading menu items: {ex.Message}");
            menuItems = new List<NavMenuItem>();
        }
    }

    private async Task<IEnumerable<NavMenuItem>> GetMenuItemsForCurrentUserAsync()
    {
        // Get current user role from authentication service
        var userRole = await AuthService.GetCurrentUserRoleAsync();
        var userEmail = await AuthService.GetCurrentUserEmailAsync();
        
        if (string.IsNullOrEmpty(userRole))
        {
            return new List<NavMenuItem>();
        }

        var items = new List<NavMenuItem>();

        // Dashboard (all users)
        items.Add(new NavMenuItem { Icon = "🏠", Label = "Dashboard", Href = "/dashboard" });

        // Reports Section - Based on user roles:
        // Employee: See only personal data
        // Owner: See only department data  
        // Finance: See all data
        items.Add(new NavMenuItem { IsSection = true, Label = "REPORTS" });
        items.Add(new NavMenuItem { Icon = "💳", Label = "Transactions", Href = "/transactions" });
        items.Add(new NavMenuItem { Icon = "✈️", Label = "Trips", Href = "/trips" });
        
        // Travel Spend report - Only Finance and Owners
        if (userRole is "Finance" or "Owner")
        {
            items.Add(new NavMenuItem { Icon = "📊", Label = "Travel Spend", Href = "/reports/travel-spend" });
        }

        // Trip Management - All authenticated users
        items.Add(new NavMenuItem { IsSection = true, Label = "TRIP MANAGEMENT" });
        items.Add(new NavMenuItem { Icon = "➕", Label = "Create Manual Trip", Href = "/trips/create" });
        items.Add(new NavMenuItem { Icon = "🔍", Label = "Trip Suggestions", Href = "/trips/suggestions" });
        
        // Trip Validation - Only Finance and Owners (for their departments)
        if (userRole is "Finance" or "Owner")
        {
            items.Add(new NavMenuItem { Icon = "✅", Label = "Trip Validation", Href = "/trips/validation" });
        }

        // Data Integrity - Finance only (full access to all controls)
        if (userRole == "Finance")
        {
            items.Add(new NavMenuItem { IsSection = true, Label = "DATA INTEGRITY" });
            items.Add(new NavMenuItem { Icon = "🛡️", Label = "Controls", Href = "/data-integrity/controls" });
            items.Add(new NavMenuItem { Icon = "🔗", Label = "Matching Engine", Href = "/data-integrity/matching" });
            items.Add(new NavMenuItem { Icon = "✂️", Label = "Split Engine", Href = "/data-integrity/split" });
        }

        // Settings - Finance only (full system configuration)
        if (userRole == "Finance")
        {
            items.Add(new NavMenuItem { IsSection = true, Label = "ADMINISTRATION" });
            items.Add(new NavMenuItem { Icon = "👥", Label = "User Management", Href = "/admin/users" });
            
            items.Add(new NavMenuItem { IsSection = true, Label = "SETTINGS" });
            items.Add(new NavMenuItem { Icon = "📋", Label = "Lists", Href = "/settings/lists" });
            items.Add(new NavMenuItem { Icon = "🌍", Label = "Countries & Cities", Href = "/settings/countries-cities" });
            items.Add(new NavMenuItem { Icon = "👥", Label = "Owners", Href = "/settings/owners" });
            items.Add(new NavMenuItem { Icon = "💰", Label = "Tax Settings", Href = "/settings/tax" });
            items.Add(new NavMenuItem { Icon = "📈", Label = "Headcount", Href = "/settings/headcount" });
            items.Add(new NavMenuItem { Icon = "📥", Label = "CSV Import", Href = "/settings/csv-import" });
            items.Add(new NavMenuItem { Icon = "⚙️", Label = "System Settings", Href = "/settings/system" });
            items.Add(new NavMenuItem { Icon = "📜", Label = "Audit Log", Href = "/settings/audit" });
        }

        return items;
    }

    private void OnLocationChanged(object? sender, LocationChangedEventArgs e)
    {
        currentLocation = e.Location;
        StateHasChanged();
    }

    private void HandleNavClick(string href)
    {
        // Force state update to ensure proper highlighting
        StateHasChanged();
    }

    private bool IsCurrentLocation(string href)
    {
        var currentUri = NavigationManager.ToBaseRelativePath(NavigationManager.Uri);
        
        // Handle root path
        if (href == "/" && (currentUri == "" || currentUri == "/"))
        {
            return true;
        }
        
        // Handle other paths
        if (href != "/" && currentUri.StartsWith(href.TrimStart('/'), StringComparison.OrdinalIgnoreCase))
        {
            return true;
        }
        
        return false;
    }

    public void Dispose()
    {
        NavigationManager.LocationChanged -= OnLocationChanged;
    }

    public class NavMenuItem
    {
        public string Icon { get; set; } = "";
        public string Label { get; set; } = "";
        public string Href { get; set; } = "";
        public bool IsSection { get; set; } = false;
    }
}
