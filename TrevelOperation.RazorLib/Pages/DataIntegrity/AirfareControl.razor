@page "/airfare-control"
@using TravelOperation.Core.Models
@using TravelOperation.Core.Models.Entities
@using TravelOperation.Core.Models.Lookup
@using TravelOperation.Core.Services
@using TravelOperation.Core.Services.Interfaces
@using TrevelOperation.RazorLib.Components
@using TravelOperation.Core.Models
@inject ITransactionService TransactionService
@inject ILookupService LookupService
@inject IJSRuntime JSRuntime

<AuthorizeRoleView RequiredRole="Finance">
<div class="container mx-auto p-6">
    <div class="flex justify-between items-center mb-6">
        <div>
            <h1 class="text-3xl font-bold text-gray-900">‚úàÔ∏è Airfare Control</h1>
            <p class="text-gray-600">Ensure all airfare transactions have cabin class assigned</p>
        </div>
        <div class="flex gap-2">
            <button class="btn btn-secondary" @onclick="RefreshData">
                üîÑ Refresh
            </button>
            <button class="btn btn-primary" @onclick="ValidateAll">
                ‚úÖ Validate All
            </button>
        </div>
    </div>

    <!-- Summary Cards -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
        <div class="card bg-yellow-50 border-l-4 border-yellow-400">
            <div class="card-body">
                <div class="flex items-center">
                    <div class="text-3xl mr-4">‚ö†Ô∏è</div>
                    <div>
                        <div class="text-2xl font-bold text-yellow-700">@incompleteCount</div>
                        <div class="text-yellow-600">Missing Cabin Class</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card bg-blue-50 border-l-4 border-blue-400">
            <div class="card-body">
                <div class="flex items-center">
                    <div class="text-3xl mr-4">‚úàÔ∏è</div>
                    <div>
                        <div class="text-2xl font-bold text-blue-700">@totalAirfareTransactions</div>
                        <div class="text-blue-600">Total Airfare</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card bg-green-50 border-l-4 border-green-400">
            <div class="card-body">
                <div class="flex items-center">
                    <div class="text-3xl mr-4">üëë</div>
                    <div>
                        <div class="text-2xl font-bold text-green-700">@premiumCount</div>
                        <div class="text-green-600">Premium Cabin</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card bg-purple-50 border-l-4 border-purple-400">
            <div class="card-body">
                <div class="flex items-center">
                    <div class="text-3xl mr-4">üí∞</div>
                    <div>
                        <div class="text-2xl font-bold text-purple-700">$@totalAirfareAmount.ToString("N0")</div>
                        <div class="text-purple-600">Total Amount</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="card bg-base-100 shadow-md mb-6">
        <div class="card-body">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div class="form-control">
                    <label class="label">
                        <span class="label-text">Owner</span>
                    </label>
                    <select class="select select-bordered w-full" @bind="selectedOwner" @bind:after="FilterTransactions">
                        <option value="">All Owners</option>
                        @foreach (var owner in availableOwners)
                        {
                            <option value="@owner">@owner</option>
                        }
                    </select>
                </div>
                <div class="form-control">
                    <label class="label">
                        <span class="label-text">Status</span>
                    </label>
                    <select class="select select-bordered w-full" @bind="selectedStatus" @bind:after="FilterTransactions">
                        <option value="">All</option>
                        <option value="missing">Missing Cabin Class</option>
                        <option value="premium">Premium Cabin</option>
                        <option value="economy">Economy</option>
                    </select>
                </div>
                <div class="form-control">
                    <label class="label">
                        <span class="label-text">Date Range</span>
                    </label>
                    <select class="select select-bordered w-full" @bind="selectedDateRange" @bind:after="FilterTransactions">
                        <option value="">All Dates</option>
                        <option value="last-30">Last 30 days</option>
                        <option value="last-90">Last 90 days</option>
                        <option value="this-year">This year</option>
                    </select>
                </div>
                <div class="form-control">
                    <label class="label">
                        <span class="label-text">Search</span>
                    </label>
                    <input type="text" class="input input-bordered w-full" placeholder="Search vendor..." @bind="searchText" @bind:after="FilterTransactions">
                </div>
            </div>
        </div>
    </div>

    <!-- Transactions Table -->
    <div class="card bg-base-100 shadow-md">
        <div class="card-body">
            <div class="overflow-x-auto">
                <table class="table table-zebra w-full">
                    <thead>
                        <tr>
                            <th>
                                <input type="checkbox" class="checkbox" @onchange="ToggleSelectAll" checked="@allSelected">
                            </th>
                            <th>Document</th>
                            <th>Transaction ID</th>
                            <th>Email</th>
                            <th>Date</th>
                            <th>Vendor</th>
                            <th>Address</th>
                            <th>Currency</th>
                            <th>Amount</th>
                            <th>Amount (USD)</th>
                            <th>Cabin Class</th>
                            <th>Category</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var transaction in pagedResult.Items)
                        {
                            <tr class="hover">
                                <td>
                                    <input type="checkbox" class="checkbox" @onchange="(e) => ToggleSelect(transaction.TransactionId, e)" checked="@selectedTransactions.Contains(transaction.TransactionId)">
                                </td>
                                <td>
                                    @if (!string.IsNullOrEmpty(transaction.DocumentUrl))
                                    {
                                        <a href="@transaction.DocumentUrl" target="_blank" class="btn btn-ghost btn-sm">üìÑ</a>
                                    }
                                    else
                                    {
                                        <span class="text-gray-400">No doc</span>
                                    }
                                </td>
                                <td>
                                    <div class="font-mono text-sm">@transaction.TransactionId</div>
                                </td>
                                <td>@transaction.Email</td>
                                <td>@transaction.TransactionDate.ToString("dd/MM/yyyy")</td>
                                <td>@transaction.Vendor</td>
                                <td>
                                    <div class="text-sm text-gray-600">@transaction.Address</div>
                                </td>
                                <td>@transaction.Currency</td>
                                <td>@transaction.Amount.ToString("N2")</td>
                                <td>$@(transaction.AmountUSD?.ToString("N2") ?? "0.00")</td>
                                <td>
                                    <select class="select select-bordered select-sm @(transaction.CabinClassId == null ? "bg-yellow-100 border-yellow-400" : "")" 
                                            @onchange="(e) => UpdateCabinClass(transaction.TransactionId, e.Value?.ToString())">
                                        <option value="">Select...</option>
                                        @foreach (var cabin in cabinClasses)
                                        {
                                            <option value="@cabin.CabinClassId" selected="@(transaction.CabinClassId == cabin.CabinClassId)">
                                                @cabin.Emoji @cabin.Name
                                            </option>
                                        }
                                    </select>
                                </td>
                                <td>
                                    <select class="select select-bordered select-sm bg-blue-50" 
                                            @onchange="(e) => UpdateCategory(transaction.TransactionId, e.Value?.ToString())">
                                        @foreach (var category in categories)
                                        {
                                            <option value="@category.CategoryId" selected="@(transaction.CategoryId == category.CategoryId)">
                                                @category.Emoji @category.Name
                                            </option>
                                        }
                                    </select>
                                </td>
                                <td>
                                    <div class="dropdown dropdown-end">
                                        <label tabindex="0" class="btn btn-ghost btn-sm">‚ãÆ</label>
                                        <ul tabindex="0" class="dropdown-content menu p-2 shadow bg-base-100 rounded-box w-52">
                                            <li><a @onclick="() => ViewDetails(transaction.TransactionId)">üëÅÔ∏è View Details</a></li>
                                            <li><a @onclick="() => GenerateMessage(transaction.TransactionId)">üìß Generate Message</a></li>
                                            <li><hr /></li>
                                            <li><a @onclick="() => MarkAsValid(transaction.TransactionId)">‚úÖ Mark Valid</a></li>
                                        </ul>
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>

            <!-- Bulk Actions -->
            @if (selectedTransactions.Any())
            {
                <div class="alert alert-info mt-4">
                    <div class="flex justify-between items-center w-full">
                        <span>@selectedTransactions.Count transaction(s) selected</span>
                        <div class="flex gap-2">
                            <button class="btn btn-sm btn-success" @onclick="MarkSelectedAsValid">
                                ‚úÖ Mark Selected as Valid
                            </button>
                            <button class="btn btn-sm btn-secondary" @onclick="ClearSelection">
                                ‚ùå Clear Selection
                            </button>
                        </div>
                    </div>
                </div>
            }

            <!-- Pagination -->
            <div class="flex justify-between items-center mt-4">
                <div class="text-sm text-gray-500">
                    Showing @pagedResult.FirstItemOnPage to @pagedResult.LastItemOnPage of @pagedResult.TotalCount transactions
                    <select class="select select-bordered select-sm ml-4" @onchange="OnPageSizeChanged">
                        <option value="25" selected="@(pageSize == 25)">25 per page</option>
                        <option value="50" selected="@(pageSize == 50)">50 per page</option>
                        <option value="100" selected="@(pageSize == 100)">100 per page</option>
                    </select>
                </div>
                <div class="join">
                    <button class="join-item btn btn-sm" disabled="@(!pagedResult.HasPreviousPage)" @onclick="PreviousPage">¬´</button>
                    @for (int i = Math.Max(1, currentPage - 2); i <= Math.Min(pagedResult.TotalPages, currentPage + 2); i++)
                    {
                        int pageNumber = i;
                        <button class="join-item btn btn-sm @(i == currentPage ? "btn-active" : "")" @onclick="() => GoToPage(pageNumber)">@i</button>
                    }
                    <button class="join-item btn btn-sm" disabled="@(!pagedResult.HasNextPage)" @onclick="NextPage">¬ª</button>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private List<Transaction> transactions = new();
    private List<Transaction> filteredTransactions = new();
    private PagedResult<Transaction> pagedResult = new();
    private List<CabinClass> cabinClasses = new();
    private List<Category> categories = new();
    private List<string> availableOwners = new();
    private HashSet<string> selectedTransactions = new();
    
    // Filters
    private string selectedOwner = "";
    private string selectedStatus = "";
    private string selectedDateRange = "";
    private string searchText = "";
    
    // Pagination
    private int currentPage = 1;
    private int pageSize = 25;
    
    // Summary data
    private int incompleteCount = 0;
    private int totalAirfareTransactions = 0;
    private int premiumCount = 0;
    private decimal totalAirfareAmount = 0;
    private bool allSelected = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadLookupData();
        await LoadAirfareTransactions();
        CalculateSummary();
        FilterTransactions();
    }

    private async Task LoadLookupData()
    {
        cabinClasses = (await LookupService.GetCabinClassesAsync()).ToList();
        categories = (await LookupService.GetCategoriesAsync()).ToList();
    }

    private async Task LoadAirfareTransactions()
    {
        // Load paged data from server
        var paginationParams = new PaginationParams
        {
            PageNumber = currentPage,
            PageSize = pageSize,
            SortBy = "TransactionDate",
            SortDirection = "desc"
        };
        
        pagedResult = await TransactionService.GetAirfareWithoutCabinClassPagedAsync(paginationParams);
        
        // Also get all airfare for summary calculations and owner filter
        var allAirfare = await TransactionService.GetAirfareWithoutCabinClassAsync();
        transactions = allAirfare.ToList();
        filteredTransactions = transactions; // For summary calculations
        
        // Extract unique owners
        availableOwners = transactions
            .Where(t => t.Trip?.Owner?.Name != null)
            .Select(t => t.Trip!.Owner!.Name)
            .Distinct()
            .ToList();
    }

    private void CalculateSummary()
    {
        incompleteCount = filteredTransactions.Count(t => t.CabinClassId == null);
        totalAirfareTransactions = filteredTransactions.Count;
        
        // Premium cabin classes (Business, First)
        var premiumCabinClasses = cabinClasses.Where(c => c.Name == "Business" || c.Name == "First").Select(c => c.CabinClassId).ToList();
        premiumCount = filteredTransactions.Count(t => t.CabinClassId.HasValue && premiumCabinClasses.Contains(t.CabinClassId.Value));
        
        totalAirfareAmount = filteredTransactions.Sum(t => t.AmountUSD ?? 0);
    }

    private async Task FilterTransactions()
    {
        // Apply client-side filtering for summary
        filteredTransactions = transactions.Where(t =>
            (string.IsNullOrEmpty(selectedOwner) || (t.Trip?.Owner?.Name == selectedOwner)) &&
            (string.IsNullOrEmpty(searchText) || 
             (t.Vendor?.Contains(searchText, StringComparison.OrdinalIgnoreCase) ?? false) ||
             t.TransactionId.Contains(searchText, StringComparison.OrdinalIgnoreCase)) &&
            FilterByStatus(t) &&
            FilterByDateRange(t)
        ).OrderByDescending(t => t.TransactionDate).ToList();
        
        CalculateSummary();
        currentPage = 1;
        selectedTransactions.Clear();
        
        // Reload with server-side pagination
        await LoadAirfareTransactions();
        StateHasChanged();
    }

    private bool FilterByStatus(Transaction transaction)
    {
        if (string.IsNullOrEmpty(selectedStatus))
            return true;

        var premiumCabinClasses = cabinClasses.Where(c => c.Name == "Business" || c.Name == "First").Select(c => c.CabinClassId).ToList();
        
        return selectedStatus switch
        {
            "missing" => transaction.CabinClassId == null,
            "premium" => transaction.CabinClassId.HasValue && premiumCabinClasses.Contains(transaction.CabinClassId.Value),
            "economy" => transaction.CabinClass?.Name == "Economy",
            _ => true
        };
    }

    private bool FilterByDateRange(Transaction transaction)
    {
        return selectedDateRange switch
        {
            "last-30" => transaction.TransactionDate >= DateTime.Today.AddDays(-30),
            "last-90" => transaction.TransactionDate >= DateTime.Today.AddDays(-90),
            "this-year" => transaction.TransactionDate.Year == DateTime.Today.Year,
            _ => true
        };
    }

    private async Task PreviousPage()
    {
        if (pagedResult.HasPreviousPage)
        {
            currentPage--;
            await LoadAirfareTransactions();
            StateHasChanged();
        }
    }

    private async Task NextPage()
    {
        if (pagedResult.HasNextPage)
        {
            currentPage++;
            await LoadAirfareTransactions();
            StateHasChanged();
        }
    }

    private async Task GoToPage(int page)
    {
        if (page >= 1 && page <= pagedResult.TotalPages)
        {
            currentPage = page;
            await LoadAirfareTransactions();
            StateHasChanged();
        }
    }

    private async Task OnPageSizeChanged(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out var newSize))
        {
            pageSize = newSize;
            currentPage = 1;
            await LoadAirfareTransactions();
            StateHasChanged();
        }
    }

    private void ToggleSelectAll(ChangeEventArgs e)
    {
        var isChecked = (bool)(e.Value ?? false);
        if (isChecked)
        {
            foreach (var transaction in pagedResult.Items)
            {
                selectedTransactions.Add(transaction.TransactionId);
            }
        }
        else
        {
            selectedTransactions.Clear();
        }
        allSelected = isChecked;
        StateHasChanged();
    }

    private void ToggleSelect(string transactionId, ChangeEventArgs e)
    {
        var isChecked = (bool)(e.Value ?? false);
        if (isChecked)
        {
            selectedTransactions.Add(transactionId);
        }
        else
        {
            selectedTransactions.Remove(transactionId);
        }
        allSelected = selectedTransactions.Count == pageSize;
        StateHasChanged();
    }

    private async Task UpdateCabinClass(string transactionId, string? cabinClassIdStr)
    {
        var transaction = transactions.FirstOrDefault(t => t.TransactionId == transactionId);
        if (transaction != null && !string.IsNullOrEmpty(cabinClassIdStr))
        {
            transaction.CabinClassId = int.Parse(cabinClassIdStr);
            await TransactionService.UpdateTransactionAsync(transaction);
            CalculateSummary();
            StateHasChanged();
        }
    }

    private async Task UpdateCategory(string transactionId, string? categoryIdStr)
    {
        var transaction = transactions.FirstOrDefault(t => t.TransactionId == transactionId);
        if (transaction != null && !string.IsNullOrEmpty(categoryIdStr))
        {
            transaction.CategoryId = int.Parse(categoryIdStr);
            await TransactionService.UpdateTransactionAsync(transaction);
            StateHasChanged();
        }
    }

    private async Task RefreshData()
    {
        await LoadAirfareTransactions();
        FilterTransactions();
    }

    private async Task ValidateAll()
    {
        var result = await JSRuntime.InvokeAsync<bool>("confirm", "Mark all visible transactions as valid?");
        if (result)
        {
            foreach (var transaction in filteredTransactions)
            {
                await TransactionService.MarkAsValidAsync(transaction.TransactionId);
            }
            await JSRuntime.InvokeVoidAsync("alert", $"Marked {filteredTransactions.Count} transactions as valid");
            await RefreshData();
        }
    }

    private async Task ViewDetails(string transactionId)
    {
        await JSRuntime.InvokeVoidAsync("alert", $"View details for transaction {transactionId} - Navigation pending");
    }

    private async Task GenerateMessage(string transactionId)
    {
        var transaction = transactions.FirstOrDefault(t => t.TransactionId == transactionId);
        if (transaction != null)
        {
            var message = GenerateAirfareMessage(transaction);
            await JSRuntime.InvokeVoidAsync("navigator.clipboard.writeText", message);
            await JSRuntime.InvokeVoidAsync("alert", "Message copied to clipboard!");
        }
    }

    private async Task MarkAsValid(string transactionId)
    {
        await TransactionService.MarkAsValidAsync(transactionId);
        var transaction = transactions.FirstOrDefault(t => t.TransactionId == transactionId);
        if (transaction != null)
        {
            transaction.IsValid = true;
            StateHasChanged();
        }
    }

    private async Task MarkSelectedAsValid()
    {
        foreach (var transactionId in selectedTransactions)
        {
            await TransactionService.MarkAsValidAsync(transactionId);
        }
        selectedTransactions.Clear();
        await JSRuntime.InvokeVoidAsync("alert", "Selected transactions marked as valid");
        await RefreshData();
    }

    private void ClearSelection()
    {
        selectedTransactions.Clear();
        allSelected = false;
        StateHasChanged();
    }

    private string GenerateAirfareMessage(Transaction transaction)
    {
        var cabinClassName = transaction.CabinClass?.Name ?? "Unknown";
        var categoryName = transaction.Category?.Name ?? "Airfare";
        return $@"Hi {GetFirstName(transaction.Email)},

I have a question about the following travel-related transaction:

Transaction ID: {transaction.TransactionId}
Date: {transaction.TransactionDate:dd/MM/yyyy}
Category: {categoryName}
Vendor: {transaction.Vendor}
Address: {transaction.Address}
Amount: {transaction.Currency} {transaction.Amount:N2}
Documentation: {transaction.DocumentUrl}

The system detected this as an airfare transaction but couldn't determine the cabin class. Could you please confirm which cabin class was booked (Economy, Premium Economy, Business, or First)?

This information is required for tax reporting purposes.

Thank you!";
    }

    private string GetFirstName(string email)
    {
        var parts = email.Split('@');
        if (parts.Length > 0)
        {
            var nameParts = parts[0].Split('.');
            return nameParts.Length > 0 ? nameParts[0] : email;
        }
        return email;
    }
}
</AuthorizeRoleView>