@page "/matching"
@using TravelOperation.Core.Services.Interfaces
@inject IMatchingService MatchingService
@inject IJSRuntime JSRuntime

<div class="container mx-auto p-6">
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-3xl font-bold text-gray-900">Matching Engine</h1>
        <div class="flex gap-2">
            <button class="btn btn-primary btn-sm" @onclick="RefreshSuggestions">
                üîÑ Refresh Suggestions
            </button>
            <button class="btn btn-outline btn-sm" @onclick="ShowStatistics">
                üìä Statistics
            </button>
        </div>
    </div>

    @if (statistics != null)
    {
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
            <div class="stat bg-base-200 rounded-lg">
                <div class="stat-title">Total Transactions</div>
                <div class="stat-value text-primary">@statistics.TotalTransactions</div>
                <div class="stat-desc">@statistics.LinkedTransactions linked (@statistics.LinkingPercentage%)</div>
            </div>
            <div class="stat bg-base-200 rounded-lg">
                <div class="stat-title">Unlinked Transactions</div>
                <div class="stat-value text-warning">@statistics.UnlinkedTransactions</div>
                <div class="stat-desc">Need trip assignment</div>
            </div>
            <div class="stat bg-base-200 rounded-lg">
                <div class="stat-title">Trips Without Transactions</div>
                <div class="stat-value text-error">@statistics.TripsWithoutTransactions</div>
                <div class="stat-desc">Out of @statistics.TotalTrips total trips</div>
            </div>
            <div class="stat bg-base-200 rounded-lg">
                <div class="stat-title">Pending Suggestions</div>
                <div class="stat-value text-accent">@statistics.PendingSuggestions</div>
                <div class="stat-desc">Ready to review</div>
            </div>
        </div>
    }

    <div class="tabs tabs-boxed mb-6">
        <a class="tab @(activeTab == "auto" ? "tab-active" : "")" @onclick='() => SetActiveTab("auto")'>
            ü§ñ Auto Suggestions
        </a>
        <a class="tab @(activeTab == "manual" ? "tab-active" : "")" @onclick='() => SetActiveTab("manual")'>
            ‚úã Manual Matching
        </a>
    </div>

    @if (activeTab == "auto")
    {
        <div class="card bg-base-100 shadow-xl">
            <div class="card-body">
                <h2 class="card-title">Automatic Matching Suggestions</h2>
                <p class="text-gray-600 mb-4">AI-powered suggestions for linking transactions to trips based on date proximity, external IDs, and transaction patterns.</p>

                @if (loading)
                {
                    <div class="flex justify-center items-center py-8">
                        <span class="loading loading-spinner loading-lg"></span>
                    </div>
                }
                else if (matchingSuggestions != null && matchingSuggestions.Any())
                {
                    @foreach (var suggestion in matchingSuggestions)
                    {
                        <div class="card bg-base-200 mb-4">
                            <div class="card-body">
                                <div class="flex justify-between items-start mb-4">
                                    <div>
                                        <h3 class="font-semibold text-lg">@suggestion.TripName</h3>
                                        <div class="text-sm text-gray-600">
                                            üìß @suggestion.Email | üìÖ @suggestion.StartDate.ToString("dd/MM/yyyy") - @suggestion.EndDate.ToString("dd/MM/yyyy")
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <div class="badge @GetConfidenceBadgeClass(suggestion.OverallConfidence) badge-lg">
                                            @suggestion.OverallConfidence% Confidence
                                        </div>
                                        <div class="text-sm mt-1">
                                            @suggestion.TotalTransactions transactions ‚Ä¢ $@suggestion.TotalAmount.ToString("N2")
                                        </div>
                                    </div>
                                </div>

                                <div class="overflow-x-auto">
                                    <table class="table table-zebra w-full">
                                        <thead>
                                            <tr>
                                                <th>Date</th>
                                                <th>Vendor</th>
                                                <th>Category</th>
                                                <th>Amount</th>
                                                <th>Confidence</th>
                                                <th>Reason</th>
                                                <th>Status</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @foreach (var transaction in suggestion.SuggestedTransactions)
                                            {
                                                <tr class="@(transaction.IsAlreadyLinked ? "opacity-50" : "")">
                                                    <td>@transaction.TransactionDate.ToString("dd/MM/yyyy")</td>
                                                    <td class="max-w-xs truncate">@transaction.Vendor</td>
                                                    <td>
                                                        <div class="badge badge-outline">@transaction.Category</div>
                                                    </td>
                                                    <td>@transaction.Currency @transaction.Amount.ToString("N2")</td>
                                                    <td>
                                                        <div class="badge @GetConfidenceBadgeClass(transaction.Confidence)">
                                                            @transaction.Confidence%
                                                        </div>
                                                    </td>
                                                    <td class="max-w-xs truncate">@transaction.MatchingReason</td>
                                                    <td>
                                                        @if (transaction.IsAlreadyLinked)
                                                        {
                                                            <div class="badge badge-success">Linked</div>
                                                        }
                                                        else
                                                        {
                                                            <div class="badge badge-warning">Unlinked</div>
                                                        }
                                                    </td>
                                                    <td>
                                                        @if (!transaction.IsAlreadyLinked)
                                                        {
                                                            <button class="btn btn-xs btn-primary" 
                                                                    @onclick="() => LinkTransaction(transaction.TransactionId, suggestion.TripId)">
                                                                üîó Link
                                                            </button>
                                                        }
                                                        else
                                                        {
                                                            <button class="btn btn-xs btn-outline" 
                                                                    @onclick="() => UnlinkTransaction(transaction.TransactionId)">
                                                                ‚ùå Unlink
                                                            </button>
                                                        }
                                                    </td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                </div>

                                <div class="card-actions justify-end mt-4">
                                    <button class="btn btn-primary" 
                                            @onclick="() => LinkAllSuggestedTransactions(suggestion)"
                                            disabled="@(!suggestion.SuggestedTransactions.Any(t => !t.IsAlreadyLinked))">
                                        üîó Link All Suggested
                                    </button>
                                </div>
                            </div>
                        </div>
                    }
                }
                else
                {
                    <div class="text-center py-8">
                        <div class="text-6xl mb-4">üéâ</div>
                        <h3 class="text-xl font-semibold text-gray-600 mb-2">No suggestions found</h3>
                        <p class="text-gray-500">All trips appear to have their transactions properly linked!</p>
                    </div>
                }
            </div>
        </div>
    }
    else if (activeTab == "manual")
    {
        <div class="card bg-base-100 shadow-xl">
            <div class="card-body">
                <h2 class="card-title">Manual Transaction Matching</h2>
                <p class="text-gray-600 mb-4">Manually search and link transactions to specific trips.</p>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div>
                        <label class="label">Trip ID</label>
                        <input type="number" class="input input-bordered w-full" @bind="selectedTripId" placeholder="Enter Trip ID" />
                    </div>
                    <div>
                        <label class="label">Email Filter</label>
                        <input type="email" class="input input-bordered w-full" @bind="emailFilter" placeholder="Filter by email" />
                    </div>
                    <div>
                        <label class="label">Days Tolerance</label>
                        <input type="number" class="input input-bordered w-full" @bind="daysTolerance" min="1" max="30" />
                    </div>
                </div>

                <div class="flex gap-2 mb-4">
                    <button class="btn btn-primary" @onclick="SearchForMatches" disabled="@(selectedTripId <= 0)">
                        üîç Search Matches
                    </button>
                    <button class="btn btn-outline" @onclick="ClearManualSearch">
                        üóëÔ∏è Clear
                    </button>
                </div>

                @if (manualSearchResults != null && manualSearchResults.Any())
                {
                    <div class="overflow-x-auto">
                        <table class="table table-zebra w-full">
                            <thead>
                                <tr>
                                    <th>Transaction ID</th>
                                    <th>Date</th>
                                    <th>Vendor</th>
                                    <th>Category</th>
                                    <th>Amount (USD)</th>
                                    <th>Current Trip</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var transaction in manualSearchResults)
                                {
                                    <tr>
                                        <td class="font-mono text-sm">@transaction.TransactionId</td>
                                        <td>@transaction.TransactionDate.ToString("dd/MM/yyyy")</td>
                                        <td class="max-w-xs truncate">@transaction.Vendor</td>
                                        <td>
                                            <div class="badge badge-outline">@GetCategoryName(transaction.CategoryId)</div>
                                        </td>
                                        <td>$@((transaction.AmountUSD ?? 0).ToString("N2"))</td>
                                        <td>
                                            @if (transaction.TripId.HasValue)
                                            {
                                                <div class="badge badge-success">Trip @transaction.TripId</div>
                                            }
                                            else
                                            {
                                                <div class="badge badge-warning">Unlinked</div>
                                            }
                                        </td>
                                        <td>
                                            @if (transaction.TripId != selectedTripId)
                                            {
                                                <button class="btn btn-xs btn-primary" 
                                                        @onclick="() => LinkTransaction(transaction.TransactionId, selectedTripId)">
                                                    üîó Link to Trip @selectedTripId
                                                </button>
                                            }
                                            @if (transaction.TripId.HasValue)
                                            {
                                                <button class="btn btn-xs btn-outline ml-1" 
                                                        @onclick="() => UnlinkTransaction(transaction.TransactionId)">
                                                    ‚ùå Unlink
                                                </button>
                                            }
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
                else if (manualSearchResults != null)
                {
                    <div class="alert alert-info">
                        <div>
                            <span>No transactions found for the specified criteria.</span>
                        </div>
                    </div>
                }
            </div>
        </div>
    }
</div>