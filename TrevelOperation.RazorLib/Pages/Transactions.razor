@page "/transactions"

@using Microsoft.AspNetCore.Components
@using TravelOperation.Core.Services.Interfaces
@using TravelOperation.Core.Models.Entities
@using TravelOperation.Core.Models.Lookup
@using TravelOperation.Core.Models
@using TrevelOperation.RazorLib.Components
@inject ITransactionService TransactionService
@inject ILookupService LookupService
@inject IJSRuntime JSRuntime
@inject NavigationManager Navigation
@inject TrevelOperation.Service.IMessageTemplateService MessageTemplateService

<PageTitle>Transactions - Travel Expense Management</PageTitle>

<style>
    .table td, .table th {
        word-wrap: break-word;
        overflow-wrap: break-word;
        white-space: normal !important;
    }
</style>

<div class="">
    <!-- Page Header -->
    <div class="flex justify-between items-center">
        <div>
            <h1 class="text-3xl font-bold text-base-content mb-2">üí≥ Transactions</h1>
            <p class="text-base-content/70">View, edit, and manage travel expense transactions</p>
            @if (TripIdFilter.HasValue)
            {
                <div class="alert alert-info mt-2">
                    <i class="fas fa-filter"></i>
                    <span>Filtering transactions for Trip ID: <strong>@TripIdFilter</strong></span>
                    <button class="btn btn-sm btn-ghost" @onclick="ClearTripFilter">
                        <i class="fas fa-times"></i> Clear Filter
                    </button>
                </div>
            }
        </div>
        <div class="flex gap-3">
            <button class="btn btn-outline btn-primary" @onclick="ImportTransactions">
                üì• Import CSV
            </button>
            <button class="btn btn-outline btn-secondary" @onclick="ExportTransactions">
                üì§ Export
            </button>
            <button class="btn btn-primary" @onclick="CreateTransaction">
                ‚ûï Add Transaction
            </button>
        </div>
    </div>

    <!-- Summary Stats -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div class="stat bg-primary text-primary-content rounded-lg">
            <div class="stat-figure text-2xl opacity-80">üí≥</div>
            <div class="stat-title text-primary-content/80">Total transactions</div>
            <div class="stat-value">@totalTransactions</div>
            <div class="stat-desc text-primary-content/60">@validTransactions validated</div>
        </div>
        <div class="stat bg-secondary text-secondary-content rounded-lg">
            <div class="stat-figure text-2xl opacity-80">üîó</div>
            <div class="stat-title text-secondary-content/80">Linked to trips</div>
            <div class="stat-value">@linkedTransactions</div>
            <div class="stat-desc text-secondary-content/60">@unlinkedTransactions unlinked</div>
        </div>
        <div class="stat bg-accent text-accent-content rounded-lg">
            <div class="stat-figure text-2xl opacity-80">üí∞</div>
            <div class="stat-title text-accent-content/80">Total amount</div>
            <div class="stat-value">$@totalAmount.ToString("N0")</div>
            <div class="stat-desc text-accent-content/60">This period</div>
        </div>
        <div class="stat bg-warning text-warning-content rounded-lg">
            <div class="stat-figure text-2xl opacity-80">‚ö†Ô∏è</div>
            <div class="stat-title text-warning-content/80">Need attention</div>
            <div class="stat-value">@flaggedTransactions</div>
            <div class="stat-desc text-warning-content/60">Validation required</div>
        </div>
    </div>

    <!-- Filters -->
    <div class="card bg-base-200 shadow-lg">
        <div class="card-body p-4">
            <div class="grid grid-cols-1 md:grid-cols-6 gap-4">
                <div class="form-control">
                    <label class="label">
                        <span class="label-text">Source</span>
                    </label>
                    <select class="select select-bordered select-sm" @bind="filterSource">
                        <option value="">All sources</option>
                        @if (sources != null)
                        {
                            @foreach (var source in sources)
                            {
                                <option value="@source.SourceId">@source.Emoji @source.Name</option>
                            }
                        }
                    </select>
                </div>
                <div class="form-control">
                    <label class="label">
                        <span class="label-text">Category</span>
                    </label>
                    <select class="select select-bordered select-sm" @bind="filterCategory">
                        <option value="">All categories</option>
                        @if (categories != null)
                        {
                            @foreach (var category in categories)
                            {
                                <option value="@category.CategoryId">@category.Emoji @category.Name</option>
                            }
                        }
                    </select>
                </div>
                <div class="form-control">
                    <label class="label">
                        <span class="label-text">Date From</span>
                    </label>
                    <input type="date" class="input input-bordered input-sm" @bind="filterDateFrom" />
                </div>
                <div class="form-control">
                    <label class="label">
                        <span class="label-text">Date To</span>
                    </label>
                    <input type="date" class="input input-bordered input-sm" @bind="filterDateTo" />
                </div>
                <div class="form-control">
                    <label class="label">
                        <span class="label-text">Status</span>
                    </label>
                    <select class="select select-bordered select-sm" @bind="filterStatus">
                        <option value="">All</option>
                        <option value="valid">‚úÖ Valid</option>
                        <option value="invalid">‚ùå Invalid</option>
                        <option value="linked">üîó Linked</option>
                        <option value="unlinked">üîì Unlinked</option>
                    </select>
                </div>
                <div class="form-control flex justify-end items-end">
                    <button class="btn btn-primary btn-sm" @onclick="ApplyFilters">
                        üîç Filter
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Transaction Table -->
    <div class="card bg-base-100 shadow-lg" style="max-height: 600px; display: flex; flex-direction: column;">
        <div class="card-body p-0" style="flex: 1; overflow: hidden; display: flex; flex-direction: column;">
            @if (isLoading)
            {
                <div class="flex justify-center items-center h-64">
                    <span class="loading loading-spinner loading-lg"></span>
                </div>
            }
            else if (filteredTransactions?.Any() == true)
            {
                <div class="overflow-y-auto" style="flex: 1; overflow-x: hidden;">
                    <table class="table table-zebra table-pin-rows" style="table-layout: fixed; width: 100%;">
                        <thead class="bg-white sticky top-0 z-10">
                            <tr class="bg-white">
                                <th class="bg-white" style="width: 30px;">
                                    <input type="checkbox" class="checkbox checkbox-sm" 
                                           @onchange="ToggleSelectAll" 
                                           checked="@(selectedTransactions.Count == filteredTransactions.Count())" />
                                </th>
                                <th class="bg-white cursor-pointer hover:bg-base-200" style="width: 150px;" @onclick="() => SortBy(nameof(Transaction.TransactionId))">
                                    Transaction ID @GetSortIcon(nameof(Transaction.TransactionId))
                                </th>
                                <th class="bg-white cursor-pointer hover:bg-base-200" style="width: 130px;" @onclick="() => SortBy(nameof(Transaction.TransactionDate))">
                                    Date @GetSortIcon(nameof(Transaction.TransactionDate))
                                </th>
                                <th class="bg-white" style="width: 80px;">Source</th>
                                <th class="bg-white" style="width: 140px;">Email</th>
                                <th class="bg-white" style="width: 120px;">Vendor</th>
                                <th class="bg-white cursor-pointer hover:bg-base-200" style="width: 110px;" @onclick="() => SortBy(nameof(Transaction.CategoryId))">
                                    Category @GetSortIcon(nameof(Transaction.CategoryId))
                                </th>
                                <th class="bg-white cursor-pointer hover:bg-base-200" style="width: 95px;" @onclick="() => SortBy(nameof(Transaction.AmountUSD))">
                                    Amount @GetSortIcon(nameof(Transaction.AmountUSD))
                                </th>
                                <th class="bg-white" style="width: 95px;">Cabin</th>
                                <th class="bg-white" style="width: 110px;">Trip</th>
                                <th class="bg-white" style="width: 70px;">Status</th>
                                <th class="bg-white" style="width: 100px;">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var transaction in filteredTransactions)
                            {
                                <tr class="hover:bg-base-200 transition-colors @(selectedTransactions.Contains(transaction.TransactionId) ? "bg-primary/10" : "")">
                                    <td>
                                        <input type="checkbox" class="checkbox checkbox-sm" 
                                               checked="@selectedTransactions.Contains(transaction.TransactionId)"
                                               @onchange="(e) => ToggleSelectTransaction(transaction.TransactionId, (bool)e.Value!)" />
                                    </td>
                                    <td class="font-mono text-sm">@transaction.TransactionId</td>
                                    <td>@transaction.TransactionDate.ToString("dd/MM/yyyy")</td>
                                    <td>
                                        @if (transaction.Source != null)
                                        {
                                            <span class="text-sm font-medium @GetSourceColor(transaction.Source.Name)">@transaction.Source.Name</span>
                                        }
                                    </td>
                                    <td class="text-sm">@transaction.Email</td>
                                    <td class="text-sm">@transaction.Vendor</td>
                                    <td>
                                        @if (transaction.Category != null)
                                        {
                                            <span class="text-sm font-medium @GetCategoryColor(transaction.Category.Name)">@transaction.Category.Name</span>
                                        }
                                        else
                                        {
                                            <span class="text-sm font-medium text-orange-600">Uncategorized</span>
                                        }
                                    </td>
                                    <td class="text-right font-mono">
                                        @if (transaction.AmountUSD.HasValue)
                                        {
                                            <span class="@(transaction.AmountUSD < 0 ? "text-error" : "text-success")">
                                                $@transaction.AmountUSD.Value.ToString("N2")
                                            </span>
                                        }
                                        else
                                        {
                                            <span class="text-warning">@transaction.Currency @transaction.Amount.ToString("N2")</span>
                                        }
                                    </td>
                                    <td>
                                        @if (transaction.CabinClass != null)
                                        {
                                            <span class="text-sm font-medium @GetCabinClassColor(transaction.CabinClass.Name)">@transaction.CabinClass.Name</span>
                                        }
                                        else if (transaction.Category?.Name == "Airfare")
                                        {
                                            <span class="text-sm font-medium text-red-600">Missing</span>
                                        }
                                    </td>
                                    <td>
                                        @if (transaction.Trip != null)
                                        {
                                            <a href="/trips/@transaction.TripId" class="link link-primary text-sm">
                                                @transaction.Trip.TripName
                                            </a>
                                        }
                                        else
                                        {
                                            <span class="text-warning text-sm">üîì Unlinked</span>
                                        }
                                    </td>
                                    <td>
                                        <div class="flex gap-1">
                                            @if (transaction.IsValid)
                                            {
                                                <span class="badge badge-success badge-sm">‚úÖ</span>
                                            }
                                            else
                                            {
                                                <span class="badge badge-error badge-sm">‚ùå</span>
                                            }
                                            @if (transaction.DataValidation)
                                            {
                                                <span class="badge badge-warning badge-sm">‚ö†Ô∏è</span>
                                            }
                                        </div>
                                    </td>
                                    <td>
                                        <div class="dropdown dropdown-end">
                                            <label tabindex="0" class="btn btn-ghost btn-sm">‚ãÆ</label>
                                            <ul tabindex="0" class="dropdown-content z-[1] menu p-2 shadow-lg bg-white border border-base-300 rounded-box w-52">
                                                <li><a @onclick="async () => { await CloseDropdown(); await EditTransaction(transaction); }">‚úèÔ∏è Edit</a></li>
                                                <li><a @onclick="async () => { await CloseDropdown(); await LinkToTrip(transaction); }">üîó Link to Trip</a></li>
                                                <li><a @onclick="async () => { await CloseDropdown(); await SplitTransaction(transaction); }">‚úÇÔ∏è Split</a></li>
                                                <li><a @onclick="async () => { await CloseDropdown(); await GenerateMessage(transaction); }">üí¨ Generate Message</a></li>
                                                <li><a @onclick="async () => { await CloseDropdown(); await ViewDocuments(transaction); }">üìÑ Documents</a></li>
                                                <li class="divider"></li>
                                                <li><a @onclick="async () => { await CloseDropdown(); await MarkAsValid(transaction); }" class="text-success">‚úÖ Mark Valid</a></li>
                                                <li><a @onclick="async () => { await CloseDropdown(); await DeleteTransaction(transaction); }" class="text-error">üóëÔ∏è Delete</a></li>
                                            </ul>
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
                
                <!-- Pagination -->
                <div class="flex justify-between items-center p-4 border-t">
                    <div class="flex items-center gap-4">
                        <div class="text-sm text-base-content/70">
                            Showing @pagedResult.FirstItemOnPage to @pagedResult.LastItemOnPage of @pagedResult.TotalCount transactions
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="text-sm text-base-content/70">Per page:</span>
                            <select class="select select-bordered select-sm w-20" @bind="pageSize" @bind:after="OnPageSizeChanged">
                                <option value="25">25</option>
                                <option value="50">50</option>
                                <option value="100">100</option>
                            </select>
                        </div>
                    </div>
                    <div class="join">
                        <button class="join-item btn btn-sm" @onclick="PreviousPage" disabled="@(!pagedResult.HasPreviousPage)">
                            ¬´ Previous
                        </button>
                        @for (int i = Math.Max(1, currentPage - 2); i <= Math.Min(pagedResult.TotalPages, currentPage + 2); i++)
                        {
                            <button class="join-item btn btn-sm @(i == currentPage ? "btn-primary" : "")" 
                                    @onclick="() => GoToPage(i)">
                                @i
                            </button>
                        }
                        <button class="join-item btn btn-sm" @onclick="NextPage" disabled="@(!pagedResult.HasNextPage)">
                            Next ¬ª
                        </button>
                    </div>
                </div>
            }
            else
            {
                <div class="flex flex-col items-center justify-center h-64 text-base-content/50">
                    <div class="text-6xl mb-4">üì≠</div>
                    <h3 class="text-xl font-semibold mb-2">No transactions found</h3>
                    <p class="text-sm">Try adjusting your filters or import some transaction data.</p>
                    <button class="btn btn-primary mt-4" @onclick="ImportTransactions">
                        üì• Import Transactions
                    </button>
                </div>
            }
        </div>
    </div>

    <!-- Bulk Actions -->
    @if (selectedTransactions.Any())
    {
        <div class="fixed bottom-6 left-1/2 transform -translate-x-1/2 z-50">
            <div class="card bg-primary text-primary-content shadow-2xl">
                <div class="card-body p-4 flex-row items-center gap-4">
                    <span class="font-semibold">@selectedTransactions.Count selected</span>
                    <div class="flex gap-2">
                        <button class="btn btn-sm btn-ghost" @onclick="BulkLinkToTrip">üîó Link to Trip</button>
                        <button class="btn btn-sm btn-ghost" @onclick="BulkMarkValid">‚úÖ Mark Valid</button>
                        <button class="btn btn-sm btn-ghost" @onclick="BulkExport">üì§ Export</button>
                        <button class="btn btn-sm btn-outline" @onclick="ClearSelection">‚úï</button>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

<!-- Modals -->
<TransactionEditModal @ref="editModal" 
                     OnTransactionUpdated="RefreshTransactions" />

<TransactionCreateModal @ref="createModal" 
                       OnTransactionCreated="RefreshTransactions" />

@code {
    // Query parameters
    [SupplyParameterFromQuery(Name = "tripId")]
    public int? TripIdFilter { get; set; }

    // Component state
    private bool isLoading = true;
    private List<Transaction> transactions = new();
    private IEnumerable<Transaction> filteredTransactions = new List<Transaction>();
    private PagedResult<Transaction> pagedResult = new();
    private HashSet<string> selectedTransactions = new();
    
    // Lookup data
    private List<Source>? sources;
    private List<Category>? categories;
    private List<CabinClass>? cabinClasses;
    
    // Filters
    private string filterSource = "";
    private string filterCategory = "";
    private DateTime? filterDateFrom;
    private DateTime? filterDateTo;
    private string filterStatus = "";
    
    // Pagination
    private int currentPage = 1;
    private int pageSize = 50;
    
    // Sorting
    private string sortField = nameof(Transaction.TransactionDate);
    private bool sortAscending = false;
    
    // Statistics (from all data, not paged)
    private int totalTransactions = 0;
    private int validTransactions = 0;
    private int linkedTransactions = 0;
    private int unlinkedTransactions = 0;
    private decimal totalAmount = 0;
    private int flaggedTransactions = 0;
    
    // Components
    private TransactionEditModal? editModal;
    private TransactionCreateModal? createModal;

    protected override async Task OnInitializedAsync()
    {
        await LoadLookupData();
        
        // If tripId filter is provided, set the filter status to show only those transactions
        if (TripIdFilter.HasValue)
        {
            filterStatus = "linked";
        }
        
        await LoadTransactions();
        isLoading = false;
    }

    private async Task LoadLookupData()
    {
        try
        {
            sources = (await LookupService.GetSourcesAsync()).ToList();
            categories = (await LookupService.GetCategoriesAsync()).ToList();
            cabinClasses = (await LookupService.GetCabinClassesAsync()).ToList();
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("console.error", "Failed to load lookup data:", ex.Message);
        }
    }

    private async Task LoadTransactions()
    {
        try
        {
            isLoading = true;
            
            // Create pagination params
            var paginationParams = new PaginationParams
            {
                PageNumber = currentPage,
                PageSize = pageSize,
                SortBy = sortField,
                SortDirection = sortAscending ? "asc" : "desc"
            };
            
            // Load all transactions for statistics (without pagination)
            transactions = await TransactionService.GetAllTransactionsAsync(includeRelated: true);
            
            // If tripId filter is provided, filter by that trip
            if (TripIdFilter.HasValue)
            {
                transactions = transactions.Where(t => t.TripId == TripIdFilter.Value).ToList();
            }
            
            UpdateStatistics();
            
            // Load paged transactions with filters
            pagedResult = await LoadPagedTransactionsAsync(paginationParams);
            filteredTransactions = pagedResult.Items;
            
            // Apply tripId filter to paged results as well
            if (TripIdFilter.HasValue)
            {
                filteredTransactions = filteredTransactions.Where(t => t.TripId == TripIdFilter.Value).ToList();
            }
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("console.error", "Failed to load transactions:", ex.Message);
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task<PagedResult<Transaction>> LoadPagedTransactionsAsync(PaginationParams paginationParams)
    {
        // Apply filters server-side by using appropriate service method
        if (!string.IsNullOrEmpty(filterStatus))
        {
            return filterStatus switch
            {
                "unlinked" => await TransactionService.GetUnlinkedTransactionsPagedAsync(paginationParams),
                _ => await TransactionService.GetAllTransactionsPagedAsync(paginationParams)
            };
        }
        
        return await TransactionService.GetAllTransactionsPagedAsync(paginationParams);
    }

    private void UpdateStatistics()
    {
        totalTransactions = transactions.Count;
        validTransactions = transactions.Count(t => t.IsValid);
        linkedTransactions = transactions.Count(t => t.TripId.HasValue);
        unlinkedTransactions = totalTransactions - linkedTransactions;
        totalAmount = transactions.Where(t => t.AmountUSD.HasValue).Sum(t => t.AmountUSD.Value);
        flaggedTransactions = transactions.Count(t => t.DataValidation || !t.IsValid);
    }

    private async Task ApplyFiltersAndSort()
    {
        // Reset to first page when filters change
        currentPage = 1;
        selectedTransactions.Clear();
        
        // Reload with new filters
        await LoadTransactions();
        StateHasChanged();
    }

    private async Task ApplyFilters()
    {
        await ApplyFiltersAndSort();
    }

    private async Task SortBy(string field)
    {
        if (sortField == field)
        {
            sortAscending = !sortAscending;
        }
        else
        {
            sortField = field;
            sortAscending = true;
        }
        
        await LoadTransactions();
        StateHasChanged();
    }

    private string GetSortIcon(string field)
    {
        if (sortField != field) return "";
        return sortAscending ? "‚Üë" : "‚Üì";
    }

    // Selection methods
    private void ToggleSelectAll(ChangeEventArgs e)
    {
        var isChecked = (bool)(e.Value ?? false);
        if (isChecked)
        {
            selectedTransactions = filteredTransactions.Select(t => t.TransactionId).ToHashSet();
        }
        else
        {
            selectedTransactions.Clear();
        }
        StateHasChanged();
    }

    private void ToggleSelectTransaction(string transactionId, bool isSelected)
    {
        if (isSelected)
        {
            selectedTransactions.Add(transactionId);
        }
        else
        {
            selectedTransactions.Remove(transactionId);
        }
        StateHasChanged();
    }

    private void ClearSelection()
    {
        selectedTransactions.Clear();
        StateHasChanged();
    }

    // Pagination methods
    private async Task PreviousPage()
    {
        if (pagedResult.HasPreviousPage)
        {
            currentPage--;
            await LoadTransactions();
            StateHasChanged();
        }
    }

    private async Task NextPage()
    {
        if (pagedResult.HasNextPage)
        {
            currentPage++;
            await LoadTransactions();
            StateHasChanged();
        }
    }

    private async Task GoToPage(int page)
    {
        currentPage = page;
        await LoadTransactions();
        StateHasChanged();
    }

    private async Task OnPageSizeChanged()
    {
        currentPage = 1; // Reset to first page when changing page size
        await LoadTransactions();
        StateHasChanged();
    }

    // Action methods
    private async Task RefreshTransactions()
    {
        await LoadTransactions();
        StateHasChanged();
    }

    private async Task EditTransaction(Transaction transaction)
    {
        if (editModal != null)
        {
            await editModal.ShowAsync(transaction);
        }
    }

    private async Task LinkToTrip(Transaction transaction)
    {
        // TODO: Implement link to trip modal - Need to create TripLinkModal component
        await JSRuntime.InvokeVoidAsync("alert", $"Link transaction {transaction.TransactionId} to trip\n\nFeature coming soon! This will allow you to:\n‚Ä¢ Select a trip from available trips\n‚Ä¢ Link this transaction to that trip\n‚Ä¢ Group expenses by trip for reporting");
    }

    private async Task SplitTransaction(Transaction transaction)
    {
        // The TransactionSplitModal uses parameters, not a Show method
        // For now, navigate to Split Engine page or show info
        await JSRuntime.InvokeVoidAsync("alert", $"Split Transaction: {transaction.TransactionId}\n\n" +
            $"This feature allows you to divide one transaction into multiple parts.\n\n" +
            $"Options:\n" +
            $"‚Ä¢ Equal Split: Divide amount equally\n" +
            $"‚Ä¢ Custom Split: Specify exact amounts\n" +
            $"‚Ä¢ Percentage Split: Assign percentages\n\n" +
            $"To use this feature, go to:\nData Integrity ‚Üí Split Engine");
    }

    private async Task GenerateMessage(Transaction transaction)
    {
        try
        {
            string message = "";
            
            // Generate message based on transaction category and issues
            if (transaction.Category?.Name == "Meals" && transaction.AmountUSD >= 80)
            {
                // Parse participants if available
                List<string>? participants = null;
                if (!string.IsNullOrEmpty(transaction.Participants))
                {
                    participants = transaction.Participants.Split(',')
                        .Select(p => p.Trim())
                        .Where(p => !string.IsNullOrEmpty(p))
                        .ToList();
                }
                message = MessageTemplateService.GenerateMealsMessage(transaction, participants);
            }
            else if (transaction.Category?.Name == "Client entertainment")
            {
                // Parse participants
                List<string> participants = new();
                if (!string.IsNullOrEmpty(transaction.Participants))
                {
                    participants = transaction.Participants.Split(',')
                        .Select(p => p.Trim())
                        .Where(p => !string.IsNullOrEmpty(p))
                        .ToList();
                }
                message = MessageTemplateService.GenerateClientEntertainmentMessage(transaction, participants);
            }
            else if (transaction.Category?.Name == "Other" || transaction.Category == null)
            {
                message = MessageTemplateService.GenerateOtherCategoryMessage(transaction, transaction.Trip);
            }
            else if (string.IsNullOrEmpty(transaction.DocumentUrl))
            {
                message = MessageTemplateService.GenerateDocumentationMessage(transaction);
            }
            else
            {
                // Default message for other cases
                message = $"Hi {transaction.Email?.Split('@')[0] ?? "User"},\n\n" +
                         $"Regarding transaction {transaction.TransactionId}:\n" +
                         $"Date: {transaction.TransactionDate:dd/MM/yyyy}\n" +
                         $"Vendor: {transaction.Vendor}\n" +
                         $"Amount: {transaction.Currency} {transaction.Amount:N2}\n\n" +
                         $"Please provide any additional information needed for this transaction.\n\n" +
                         $"Thank you!";
            }
            
            // Copy to clipboard
            await JSRuntime.InvokeVoidAsync("navigator.clipboard.writeText", message);
            await JSRuntime.InvokeVoidAsync("alert", "‚úÖ Message copied to clipboard!\n\nYou can now paste it into your email client.");
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"Failed to generate message: {ex.Message}");
        }
    }

    private async Task ViewDocuments(Transaction transaction)
    {
        if (!string.IsNullOrEmpty(transaction.DocumentUrl))
        {
            await JSRuntime.InvokeVoidAsync("window.open", transaction.DocumentUrl, "_blank");
        }
        else
        {
            await JSRuntime.InvokeVoidAsync("alert", "No documents available for this transaction");
        }
    }

    private async Task MarkAsValid(Transaction transaction)
    {
        try
        {
            await TransactionService.MarkAsValidAsync(transaction.TransactionId);
            await RefreshTransactions();
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("console.error", "Failed to mark transaction as valid:", ex.Message);
        }
    }

    private async Task DeleteTransaction(Transaction transaction)
    {
        var confirmed = await JSRuntime.InvokeAsync<bool>("confirm", 
            $"Are you sure you want to delete transaction {transaction.TransactionId}?");
        
        if (confirmed)
        {
            try
            {
                await TransactionService.DeleteAsync(transaction.TransactionId);
                await RefreshTransactions();
            }
            catch (Exception ex)
            {
                await JSRuntime.InvokeVoidAsync("console.error", "Failed to delete transaction:", ex.Message);
            }
        }
    }

    private void CreateTransaction()
    {
        // Open the create modal for adding a new transaction
        if (createModal != null)
        {
            createModal.Show();
        }
        else
        {
            JSRuntime.InvokeVoidAsync("console.error", "createModal is null!");
            JSRuntime.InvokeVoidAsync("alert", "Error: Create modal component not initialized. Please refresh the page.");
        }
    }

    private void ClearTripFilter()
    {
        Navigation.NavigateTo("/transactions");
    }

    private async Task ImportTransactions()
    {
        Navigation.NavigateTo("/settings/csv-import");
    }

    private async Task ExportTransactions()
    {
        // TODO: Implement export functionality
        await JSRuntime.InvokeVoidAsync("alert", "Export functionality coming soon");
    }

    // Bulk actions
    private async Task BulkLinkToTrip()
    {
        // TODO: Implement bulk link to trip
        await JSRuntime.InvokeVoidAsync("alert", $"Link {selectedTransactions.Count} transactions to trip");
    }

    private async Task BulkMarkValid()
    {
        try
        {
            foreach (var transactionId in selectedTransactions)
            {
                await TransactionService.MarkAsValidAsync(transactionId);
            }
            await RefreshTransactions();
            ClearSelection();
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("console.error", "Failed to mark transactions as valid:", ex.Message);
        }
    }

    private async Task BulkExport()
    {
        // TODO: Implement bulk export
        await JSRuntime.InvokeVoidAsync("alert", $"Export {selectedTransactions.Count} transactions");  
    }

    // Helper method to close dropdown menus
    private async Task CloseDropdown()
    {
        // Remove focus from active element to close dropdown
        await JSRuntime.InvokeVoidAsync("eval", "document.activeElement?.blur()");
    }

    // Helper method to get color class for source
    private string GetSourceColor(string sourceName)
    {
        return sourceName?.ToLower() switch
        {
            "navan" => "text-blue-600",
            "agent" => "text-purple-600",
            "manual" => "text-orange-600",
            _ => "text-gray-600"
        };
    }

    // Helper method to get color class for category
    private string GetCategoryColor(string categoryName)
    {
        return categoryName?.ToLower() switch
        {
            "airfare" => "text-blue-600",
            "lodging" => "text-purple-600",
            "meals" => "text-green-600",
            "transportation" => "text-yellow-600",
            "communication" => "text-cyan-600",
            "client entertainment" => "text-pink-600",
            "other" => "text-gray-600",
            "non-travel" => "text-red-600",
            _ => "text-gray-600"
        };
    }

    // Helper method to get color class for cabin class
    private string GetCabinClassColor(string cabinClassName)
    {
        return cabinClassName?.ToLower() switch
        {
            "economy" => "text-green-600",
            "premium economy" => "text-blue-600",
            "business" => "text-purple-600",
            "first" => "text-orange-600",
            _ => "text-gray-600"
        };
    }
}