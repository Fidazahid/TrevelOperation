@page "/transactions"

@using Microsoft.AspNetCore.Components
@using TravelOperation.Core.Services.Interfaces
@using TravelOperation.Core.Models.Entities
@using TravelOperation.Core.Models.Lookup
@using TravelOperation.Core.Models
@using TravelOperation.Core.Interfaces
@using TrevelOperation.RazorLib.Components
@inject ITransactionService TransactionService
@inject ILookupService LookupService
@inject ITripService TripService
@inject IJSRuntime JSRuntime
@inject NavigationManager Navigation
@inject TrevelOperation.Service.IMessageTemplateService MessageTemplateService

<PageTitle>Transactions - Travel Expense Management</PageTitle>

<style>
    .table td, .table th {
        word-wrap: break-word;
        overflow-wrap: break-word;
        white-space: normal !important;
    }
</style>

<div class="flex flex-col gap-4">
    <!-- Page Header -->
    <div class="flex justify-between items-center">
        <div>
            <h1 class="text-3xl font-bold text-base-content mb-2">üí≥ Transactions</h1>
            <p class="text-base-content/70">View, edit, and manage travel expense transactions</p>
            @if (TripIdFilter.HasValue)
            {
                <div class="alert alert-info mt-2">
                    <i class="fas fa-filter"></i>
                    <span>Filtering transactions for Trip ID: <strong>@TripIdFilter</strong></span>
                    <button class="btn btn-sm btn-ghost" @onclick="ClearTripFilter">
                        <i class="fas fa-times"></i> Clear Filter
                    </button>
                </div>
            }
        </div>
        <div class="flex gap-3">
            <button class="btn btn-outline btn-primary" @onclick="ImportTransactions">
                üì• Import CSV
            </button>
            <button class="btn btn-outline btn-secondary" @onclick="ExportTransactions">
                üì§ Export
            </button>
            <button class="btn btn-primary" @onclick="CreateTransaction">
                ‚ûï Add Transaction
            </button>
        </div>
    </div>

    <!-- Summary Stats -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div class="stat bg-primary text-primary-content rounded-lg">
            <div class="stat-figure text-2xl opacity-80">üí≥</div>
            <div class="stat-title text-primary-content/80">Total transactions</div>
            <div class="stat-value">@totalTransactions</div>
            <div class="stat-desc text-primary-content/60">@validTransactions validated</div>
        </div>
        <div class="stat bg-secondary text-secondary-content rounded-lg">
            <div class="stat-figure text-2xl opacity-80">üîó</div>
            <div class="stat-title text-secondary-content/80">Linked to trips</div>
            <div class="stat-value">@linkedTransactions</div>
            <div class="stat-desc text-secondary-content/60">@unlinkedTransactions unlinked</div>
        </div>
        <div class="stat bg-accent text-accent-content rounded-lg">
            <div class="stat-figure text-2xl opacity-80">üí∞</div>
            <div class="stat-title text-accent-content/80">Total amount</div>
            <div class="stat-value">$@totalAmount.ToString("N0")</div>
            <div class="stat-desc text-accent-content/60">This period</div>
        </div>
        <div class="stat bg-warning text-warning-content rounded-lg">
            <div class="stat-figure text-2xl opacity-80">‚ö†Ô∏è</div>
            <div class="stat-title text-warning-content/80">Need attention</div>
            <div class="stat-value">@flaggedTransactions</div>
            <div class="stat-desc text-warning-content/60">Validation required</div>
        </div>
    </div>

    <!-- Filters -->
    <div class="card bg-base-200 shadow-lg">
        <div class="card-body p-4">
            <div class="grid grid-cols-1 md:grid-cols-6 gap-4">
                <div class="form-control">
                    <label class="label">
                        <span class="label-text">Source</span>
                    </label>
                    <select class="select select-bordered select-sm" @bind="filterSource">
                        <option value="">All sources</option>
                        @if (sources != null)
                        {
                            @foreach (var source in sources)
                            {
                                <option value="@source.SourceId">@source.Emoji @source.Name</option>
                            }
                        }
                    </select>
                </div>
                <div class="form-control">
                    <label class="label">
                        <span class="label-text">Category</span>
                    </label>
                    <select class="select select-bordered select-sm" @bind="filterCategory">
                        <option value="">All categories</option>
                        @if (categories != null)
                        {
                            @foreach (var category in categories)
                            {
                                <option value="@category.CategoryId">@category.Emoji @category.Name</option>
                            }
                        }
                    </select>
                </div>
                <div class="form-control">
                    <label class="label">
                        <span class="label-text">Date From</span>
                    </label>
                    <input type="date" class="input input-bordered input-sm" @bind="filterDateFrom" />
                </div>
                <div class="form-control">
                    <label class="label">
                        <span class="label-text">Date To</span>
                    </label>
                    <input type="date" class="input input-bordered input-sm" @bind="filterDateTo" />
                </div>
                <div class="form-control">
                    <label class="label">
                        <span class="label-text">Status</span>
                    </label>
                    <select class="select select-bordered select-sm" @bind="filterStatus">
                        <option value="">All</option>
                        <option value="valid">‚úÖ Valid</option>
                        <option value="invalid">‚ùå Invalid</option>
                        <option value="linked">üîó Linked</option>
                        <option value="unlinked">üîì Unlinked</option>
                    </select>
                </div>
                <div class="form-control flex justify-end items-end">
                    <button class="btn btn-primary btn-sm" @onclick="ApplyFilters">
                        üîç Filter
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Transaction Table -->
    <div class="card bg-base-100 shadow-lg" style="min-height: 600px;">
        <div class="card-body p-0">
            @if (isLoading)
            {
                <div class="flex justify-center items-center h-64">
                    <span class="loading loading-spinner loading-lg"></span>
                </div>
            }
            else if (filteredTransactions?.Any() == true)
            {
                <div class="overflow-y-auto" style="max-height: 600px;">
                    <table class="table table-zebra table-pin-rows" style="table-layout: fixed; width: 100%;">
                        <thead class="bg-white sticky top-0 z-10">
                            <tr class="bg-white">
                                <th class="bg-white" style="width: 30px;">
                                    <input type="checkbox" class="checkbox checkbox-sm" 
                                           @onchange="ToggleSelectAll" 
                                           checked="@(selectedTransactions.Count == filteredTransactions.Count())" />
                                </th>
                                <th class="bg-white cursor-pointer hover:bg-base-200" style="width: 100px;" @onclick="() => SortBy(nameof(Transaction.TransactionId))">
                                    Transaction ID @GetSortIcon(nameof(Transaction.TransactionId))
                                </th>
                                <th class="bg-white cursor-pointer hover:bg-base-200" style="width: 120px;" @onclick="() => SortBy(nameof(Transaction.TransactionDate))">
                                    Date @GetSortIcon(nameof(Transaction.TransactionDate))
                                </th>
                                <th class="bg-white" style="width: 80px;">Source</th>
                                <th class="bg-white" style="width: 140px;">Email</th>
                                <th class="bg-white" style="width: 120px;">Vendor</th>
                                <th class="bg-white cursor-pointer hover:bg-base-200" style="width: 110px;" @onclick="() => SortBy(nameof(Transaction.CategoryId))">
                                    Category @GetSortIcon(nameof(Transaction.CategoryId))
                                </th>
                                <th class="bg-white cursor-pointer hover:bg-base-200" style="width: 95px;" @onclick="() => SortBy(nameof(Transaction.AmountUSD))">
                                    Amount @GetSortIcon(nameof(Transaction.AmountUSD))
                                </th>
                                <th class="bg-white" style="width: 95px;">Cabin</th>
                                <th class="bg-white" style="width: 110px;">Trip</th>
                                <th class="bg-white" style="width: 70px;">Status</th>
                                <th class="bg-white" style="width: 100px;">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var transaction in filteredTransactions)
                            {
                                <tr class="hover:bg-base-200 transition-colors @(selectedTransactions.Contains(transaction.TransactionId) ? "bg-primary/10" : "")">
                                    <td>
                                        <input type="checkbox" class="checkbox checkbox-sm" 
                                               checked="@selectedTransactions.Contains(transaction.TransactionId)"
                                               @onchange="(e) => ToggleSelectTransaction(transaction.TransactionId, (bool)e.Value!)" />
                                    </td>
                                    <td class="font-mono text-sm">@transaction.TransactionId</td>
                                    <td>@transaction.TransactionDate.ToString("dd/MM/yyyy")</td>
                                    <td>
                                        @if (transaction.Source != null)
                                        {
                                            <span class="text-sm font-medium @GetSourceColor(transaction.Source.Name)">@transaction.Source.Name</span>
                                        }
                                    </td>
                                    <td class="text-sm">@transaction.Email</td>
                                    <td class="text-sm">@transaction.Vendor</td>
                                    <td>
                                        @if (transaction.Category != null)
                                        {
                                            <span class="text-sm font-medium @GetCategoryColor(transaction.Category.Name)">@transaction.Category.Name</span>
                                        }
                                        else
                                        {
                                            <span class="text-sm font-medium text-orange-600">Uncategorized</span>
                                        }
                                    </td>
                                    <td class="text-right font-mono">
                                        @if (transaction.AmountUSD.HasValue)
                                        {
                                            <span class="@(transaction.AmountUSD < 0 ? "text-error" : "text-success")">
                                                $@transaction.AmountUSD.Value.ToString("N2")
                                            </span>
                                        }
                                        else
                                        {
                                            <span class="text-warning">@transaction.Currency @transaction.Amount.ToString("N2")</span>
                                        }
                                    </td>
                                    <td>
                                        @if (transaction.CabinClass != null)
                                        {
                                            <span class="text-sm font-medium @GetCabinClassColor(transaction.CabinClass.Name)">@transaction.CabinClass.Name</span>
                                        }
                                        else if (transaction.Category?.Name == "Airfare")
                                        {
                                            <span class="text-sm font-medium text-red-600">Missing</span>
                                        }
                                    </td>
                                    <td>
                                        @if (transaction.Trip != null)
                                        {
                                            <a href="/trips/@transaction.TripId" class="link link-primary text-sm">
                                                @transaction.Trip.TripName
                                            </a>
                                        }
                                        else
                                        {
                                            <span class="text-warning text-sm">üîì Unlinked</span>
                                        }
                                    </td>
                                    <td>
                                        <div class="flex gap-1">
                                            @if (transaction.IsValid)
                                            {
                                                <span class="badge badge-success badge-sm">‚úÖ</span>
                                            }
                                            else
                                            {
                                                <span class="badge badge-error badge-sm">‚ùå</span>
                                            }
                                            @if (transaction.DataValidation)
                                            {
                                                <span class="badge badge-warning badge-sm">‚ö†Ô∏è</span>
                                            }
                                        </div>
                                    </td>
                                    <td>
                                        <div class="dropdown dropdown-end">
                                            <label tabindex="0" class="btn btn-ghost btn-sm">‚ãÆ</label>
                                            <ul tabindex="0" class="dropdown-content z-[1] menu p-2 shadow-lg bg-white border border-base-300 rounded-box w-52">
                                                <li><a @onclick="async () => { await CloseDropdown(); await EditTransaction(transaction); }">‚úèÔ∏è Edit</a></li>
                                                <li><a @onclick="async () => { await CloseDropdown(); await LinkToTrip(transaction); }">üîó Link to Trip</a></li>
                                                <li><a @onclick="async () => { await CloseDropdown(); await SplitTransaction(transaction); }">‚úÇÔ∏è Split</a></li>
                                                <li><a @onclick="async () => { await CloseDropdown(); await GenerateMessage(transaction); }">üí¨ Generate Message</a></li>
                                                <li><a @onclick="async () => { await CloseDropdown(); await ViewDocuments(transaction); }">üìÑ Documents</a></li>
                                                <li class="divider"></li>
                                                <li><a @onclick="async () => { await CloseDropdown(); await MarkAsValid(transaction); }" class="text-success">‚úÖ Mark Valid</a></li>
                                                <li><a @onclick="async () => { await CloseDropdown(); await DeleteTransaction(transaction); }" class="text-error">üóëÔ∏è Delete</a></li>
                                            </ul>
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
                
                <!-- Pagination -->
                <div class="flex justify-between items-center p-4 border-t">
                    <div class="flex items-center gap-4">
                        <div class="text-sm text-base-content/70">
                            Showing @pagedResult.FirstItemOnPage to @pagedResult.LastItemOnPage of @pagedResult.TotalCount transactions
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="text-sm text-base-content/70">Per page:</span>
                            <select class="select select-bordered select-sm w-20" @bind="pageSize" @bind:after="OnPageSizeChanged">
                                <option value="25">25</option>
                                <option value="50">50</option>
                                <option value="100">100</option>
                            </select>
                        </div>
                    </div>
                    <div class="join">
                        <button class="join-item btn btn-sm" @onclick="PreviousPage" disabled="@(!pagedResult.HasPreviousPage)">
                            ¬´ Previous
                        </button>
                        @for (int i = Math.Max(1, currentPage - 2); i <= Math.Min(pagedResult.TotalPages, currentPage + 2); i++)
                        {
                            <button class="join-item btn btn-sm @(i == currentPage ? "btn-primary" : "")" 
                                    @onclick="() => GoToPage(i)">
                                @i
                            </button>
                        }
                        <button class="join-item btn btn-sm" @onclick="NextPage" disabled="@(!pagedResult.HasNextPage)">
                            Next ¬ª
                        </button>
                    </div>
                </div>
            }
            else
            {
                <div class="flex flex-col items-center justify-center h-64 text-base-content/50">
                    <div class="text-6xl mb-4">üì≠</div>
                    <h3 class="text-xl font-semibold mb-2">No transactions found</h3>
                    <p class="text-sm">Try adjusting your filters or import some transaction data.</p>
                    <button class="btn btn-primary mt-4" @onclick="ImportTransactions">
                        üì• Import Transactions
                    </button>
                </div>
            }
        </div>
    </div>

    <!-- Bulk Actions -->
    @if (selectedTransactions.Any())
    {
        <div class="fixed bottom-6 left-1/2 transform -translate-x-1/2 z-50">
            <div class="card bg-primary text-primary-content shadow-2xl">
                <div class="card-body p-4 flex-row items-center gap-4">
                    <span class="font-semibold">@selectedTransactions.Count selected</span>
                    <div class="flex gap-2">
                        <button class="btn btn-sm btn-ghost" @onclick="BulkLinkToTrip">üîó Link to Trip</button>
                        <button class="btn btn-sm btn-ghost" @onclick="BulkMarkValid">‚úÖ Mark Valid</button>
                        <button class="btn btn-sm btn-ghost" @onclick="BulkExport">üì§ Export</button>
                        <button class="btn btn-sm btn-outline" @onclick="ClearSelection">‚úï</button>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

<!-- Modals -->
<TransactionEditModal @ref="editModal" 
                     OnTransactionUpdated="RefreshTransactions" />

<TransactionCreateModal @ref="createModal" 
                       OnTransactionCreated="RefreshTransactions" />

<LinkTransactionsModal IsVisible="@showLinkModal"
                      TripId="@selectedTripIdForLink"
                      Trip="@selectedTripForLink"
                      OnClose="CloseLinkModal"
                      OnTransactionsLinked="OnTransactionsLinked" />

<TransactionSplitModal ShowModal="@showSplitModal"
                      Transaction="@selectedTransactionForSplit"
                      Categories="@categories"
                      AvailableParticipants="@availableParticipants"
                      OnSplitSaved="OnSplitSaved"
                      OnCancel="CloseSplitModal" />

<!-- Dialog Components -->
<AlertDialog IsVisible="@showAlertDialog"
            Title="@alertTitle"
            Message="@alertMessage"
            Type="@alertType"
            OkButtonText="@alertOkText"
            OnClose="CloseAlertDialog" />

<ConfirmDialog IsVisible="@showConfirmDialog"
              Title="@confirmTitle"
              Message="@confirmMessage"
              Icon="@confirmIcon"
              ConfirmButtonText="@confirmButtonText"
              CancelButtonText="@cancelButtonText"
              ConfirmButtonClass="@confirmButtonClass"
              OnResult="HandleConfirmResult" />

@code {
    // Query parameters
    [SupplyParameterFromQuery(Name = "tripId")]
    public int? TripIdFilter { get; set; }

    // Component state
    private bool isLoading = true;
    private List<Transaction> transactions = new();
    private IEnumerable<Transaction> filteredTransactions = new List<Transaction>();
    private PagedResult<Transaction> pagedResult = new();
    private HashSet<string> selectedTransactions = new();
    
    // AlertDialog state
    private bool showAlertDialog = false;
    private string alertTitle = "";
    private string alertMessage = "";
    private AlertDialog.AlertType alertType = AlertDialog.AlertType.Info;
    private string alertOkText = "OK";
    
    // ConfirmDialog state
    private bool showConfirmDialog = false;
    private string confirmTitle = "";
    private string confirmMessage = "";
    private string confirmIcon = "";
    private string confirmButtonText = "Confirm";
    private string cancelButtonText = "Cancel";
    private string confirmButtonClass = "btn-primary";
    private Func<Task>? pendingConfirmAction;
    
    // Lookup data
    private List<Source>? sources;
    private List<Category>? categories;
    private List<CabinClass>? cabinClasses;
    
    // Filters
    private string filterSource = "";
    private string filterCategory = "";
    private DateTime? filterDateFrom;
    private DateTime? filterDateTo;
    private string filterStatus = "";
    
    // Pagination
    private int currentPage = 1;
    private int pageSize = 50;
    
    // Sorting
    private string sortField = nameof(Transaction.TransactionDate);
    private bool sortAscending = false;
    
    // Statistics (from all data, not paged)
    private int totalTransactions = 0;
    private int validTransactions = 0;
    private int linkedTransactions = 0;
    private int unlinkedTransactions = 0;
    private decimal totalAmount = 0;
    private int flaggedTransactions = 0;
    
    // Components
    private TransactionEditModal? editModal;
    private TransactionCreateModal? createModal;
    
    // Link to Trip modal state
    private bool showLinkModal = false;
    private int selectedTripIdForLink = 0;
    private Trip? selectedTripForLink = null;
    
    // Split modal state
    private bool showSplitModal = false;
    private Transaction? selectedTransactionForSplit = null;
    private List<string>? availableParticipants = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadLookupData();
        
        // If tripId filter is provided, set the filter status to show only those transactions
        if (TripIdFilter.HasValue)
        {
            filterStatus = "linked";
        }
        
        await LoadTransactions();
        isLoading = false;
    }

    private async Task LoadLookupData()
    {
        try
        {
            sources = (await LookupService.GetSourcesAsync()).ToList();
            categories = (await LookupService.GetCategoriesAsync()).ToList();
            cabinClasses = (await LookupService.GetCabinClassesAsync()).ToList();
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("console.error", "Failed to load lookup data:", ex.Message);
        }
    }

    private async Task LoadTransactions()
    {
        try
        {
            isLoading = true;
            
            Console.WriteLine("üîÑ LoadTransactions started");
            
            // Load all transactions for statistics and filtering
            var allTransactions = await TransactionService.GetAllTransactionsAsync(includeRelated: true);
            Console.WriteLine($"üì• Loaded {allTransactions.Count} transactions from database");
            
            // Apply filters
            transactions = ApplyFiltersToTransactions(allTransactions);
            
            // Update statistics based on filtered data
            UpdateStatistics();
            
            // Apply sorting
            var sortedTransactions = ApplySorting(transactions);
            
            // Apply pagination
            var totalCount = sortedTransactions.Count();
            var skip = (currentPage - 1) * pageSize;
            
            filteredTransactions = sortedTransactions
                .Skip(skip)
                .Take(pageSize)
                .ToList();
            
            Console.WriteLine($"üìÑ Page {currentPage}: Showing {filteredTransactions.Count()} of {totalCount} transactions");
            
            // Update paged result (TotalPages is calculated automatically)
            pagedResult = new PagedResult<Transaction>
            {
                Items = filteredTransactions.ToList(),
                PageNumber = currentPage,
                PageSize = pageSize,
                TotalCount = totalCount
            };
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("console.error", "Failed to load transactions:", ex.Message);
        }
        finally
        {
            isLoading = false;
        }
    }
    
    private List<Transaction> ApplyFiltersToTransactions(List<Transaction> allTransactions)
    {
        var filtered = allTransactions.AsEnumerable();
        
        Console.WriteLine($"üìä Before filtering: {allTransactions.Count} transactions");
        
        // Apply tripId filter if provided
        if (TripIdFilter.HasValue)
        {
            filtered = filtered.Where(t => t.TripId == TripIdFilter.Value);
            Console.WriteLine($"‚úÖ TripId filter applied: {TripIdFilter.Value}");
        }
        
        // Apply source filter
        if (!string.IsNullOrEmpty(filterSource))
        {
            if (int.TryParse(filterSource, out int sourceId))
            {
                filtered = filtered.Where(t => t.SourceId == sourceId);
                Console.WriteLine($"‚úÖ Source filter applied: {sourceId}");
            }
        }
        
        // Apply category filter
        if (!string.IsNullOrEmpty(filterCategory))
        {
            if (int.TryParse(filterCategory, out int categoryId))
            {
                filtered = filtered.Where(t => t.CategoryId == categoryId);
                Console.WriteLine($"‚úÖ Category filter applied: {categoryId}");
            }
        }
        
        // Apply date from filter
        if (filterDateFrom.HasValue)
        {
            filtered = filtered.Where(t => t.TransactionDate >= filterDateFrom.Value);
            Console.WriteLine($"‚úÖ DateFrom filter applied: {filterDateFrom.Value:dd/MM/yyyy}");
        }
        
        // Apply date to filter
        if (filterDateTo.HasValue)
        {
            filtered = filtered.Where(t => t.TransactionDate <= filterDateTo.Value);
            Console.WriteLine($"‚úÖ DateTo filter applied: {filterDateTo.Value:dd/MM/yyyy}");
        }
        
        // Apply status filter
        if (!string.IsNullOrEmpty(filterStatus))
        {
            filtered = filterStatus switch
            {
                "valid" => filtered.Where(t => t.IsValid),
                "invalid" => filtered.Where(t => !t.IsValid),
                "linked" => filtered.Where(t => t.TripId.HasValue),
                "unlinked" => filtered.Where(t => !t.TripId.HasValue),
                _ => filtered
            };
            Console.WriteLine($"‚úÖ Status filter applied: {filterStatus}");
        }
        
        var result = filtered.ToList();
        Console.WriteLine($"üìä After filtering: {result.Count} transactions");
        
        return result;
    }
    
    private IEnumerable<Transaction> ApplySorting(List<Transaction> transactionsToSort)
    {
        var sorted = transactionsToSort.AsEnumerable();
        
        sorted = sortField switch
        {
            nameof(Transaction.TransactionId) => sortAscending 
                ? sorted.OrderBy(t => t.TransactionId) 
                : sorted.OrderByDescending(t => t.TransactionId),
            nameof(Transaction.TransactionDate) => sortAscending 
                ? sorted.OrderBy(t => t.TransactionDate) 
                : sorted.OrderByDescending(t => t.TransactionDate),
            nameof(Transaction.CategoryId) => sortAscending 
                ? sorted.OrderBy(t => t.Category?.Name) 
                : sorted.OrderByDescending(t => t.Category?.Name),
            nameof(Transaction.AmountUSD) => sortAscending 
                ? sorted.OrderBy(t => t.AmountUSD ?? 0) 
                : sorted.OrderByDescending(t => t.AmountUSD ?? 0),
            _ => sortAscending 
                ? sorted.OrderBy(t => t.TransactionDate) 
                : sorted.OrderByDescending(t => t.TransactionDate)
        };
        
        return sorted;
    }

    private void UpdateStatistics()
    {
        totalTransactions = transactions.Count;
        validTransactions = transactions.Count(t => t.IsValid);
        linkedTransactions = transactions.Count(t => t.TripId.HasValue);
        unlinkedTransactions = totalTransactions - linkedTransactions;
        totalAmount = transactions.Where(t => t.AmountUSD.HasValue).Sum(t => t.AmountUSD.Value);
        flaggedTransactions = transactions.Count(t => t.DataValidation || !t.IsValid);
    }

    private async Task ApplyFiltersAndSort()
    {
        // Reset to first page when filters change
        currentPage = 1;
        selectedTransactions.Clear();
        
        // Reload with new filters
        await LoadTransactions();
        StateHasChanged();
    }

    private async Task ApplyFilters()
    {
        await JSRuntime.InvokeVoidAsync("console.log", "üîç ApplyFilters called");
        await JSRuntime.InvokeVoidAsync("console.log", "Filter values:", new {
            filterSource,
            filterCategory,
            filterDateFrom,
            filterDateTo,
            filterStatus
        });
        await ApplyFiltersAndSort();
    }

    private async Task SortBy(string field)
    {
        if (sortField == field)
        {
            sortAscending = !sortAscending;
        }
        else
        {
            sortField = field;
            sortAscending = true;
        }
        
        await LoadTransactions();
        StateHasChanged();
    }

    private string GetSortIcon(string field)
    {
        if (sortField != field) return "";
        return sortAscending ? "‚Üë" : "‚Üì";
    }

    // Selection methods
    private void ToggleSelectAll(ChangeEventArgs e)
    {
        var isChecked = (bool)(e.Value ?? false);
        if (isChecked)
        {
            selectedTransactions = filteredTransactions.Select(t => t.TransactionId).ToHashSet();
        }
        else
        {
            selectedTransactions.Clear();
        }
        StateHasChanged();
    }

    private void ToggleSelectTransaction(string transactionId, bool isSelected)
    {
        if (isSelected)
        {
            selectedTransactions.Add(transactionId);
        }
        else
        {
            selectedTransactions.Remove(transactionId);
        }
        StateHasChanged();
    }

    private void ClearSelection()
    {
        selectedTransactions.Clear();
        StateHasChanged();
    }

    // Pagination methods
    private async Task PreviousPage()
    {
        if (pagedResult.HasPreviousPage)
        {
            currentPage--;
            await LoadTransactions();
            StateHasChanged();
        }
    }

    private async Task NextPage()
    {
        if (pagedResult.HasNextPage)
        {
            currentPage++;
            await LoadTransactions();
            StateHasChanged();
        }
    }

    private async Task GoToPage(int page)
    {
        currentPage = page;
        await LoadTransactions();
        StateHasChanged();
    }

    private async Task OnPageSizeChanged()
    {
        currentPage = 1; // Reset to first page when changing page size
        await LoadTransactions();
        StateHasChanged();
    }

    // Action methods
    private async Task RefreshTransactions()
    {
        await LoadTransactions();
        StateHasChanged();
    }

    private async Task EditTransaction(Transaction transaction)
    {
        if (editModal != null)
        {
            await editModal.ShowAsync(transaction);
        }
    }

    private async Task LinkToTrip(Transaction transaction)
    {
        try
        {
            // Validate transaction has email
            if (string.IsNullOrEmpty(transaction.Email))
            {
                ShowAlert("Missing Email", "Transaction does not have an email address.", "Error");
                return;
            }

            // If transaction is already linked to a trip, open that trip's modal
            if (transaction.TripId.HasValue)
            {
                var existingTrip = await TripService.GetTripByIdAsync(transaction.TripId.Value);
                if (existingTrip != null)
                {
                    selectedTripIdForLink = existingTrip.TripId;
                    selectedTripForLink = existingTrip;
                    showLinkModal = true;
                    StateHasChanged();
                    return;
                }
            }

            // If not linked, we need to let user select a trip
            // Get all trips for the transaction's email
            var trips = await TripService.GetTripsByEmailAsync(transaction.Email);
            
            if (!trips.Any())
            {
                ShowAlert("No Trips Found", 
                    $"No trips found for {transaction.Email}.\n\n" +
                    $"Please create a trip first or use the Matching Engine to link transactions automatically.", 
                    "Warning");
                return;
            }

            // If only one trip, use it automatically
            if (trips.Count() == 1)
            {
                var trip = trips.First();
                selectedTripIdForLink = trip.TripId;
                selectedTripForLink = trip;
                showLinkModal = true;
                StateHasChanged();
                return;
            }

            // Multiple trips - need trip selection modal (could be enhanced with a TripSelectorModal)
            // For now, show alert with options
            var tripOptions = string.Join("\n", trips.Select(t => 
                $"‚Ä¢ {t.TripName} ({t.StartDate:dd/MM/yyyy} - {t.EndDate:dd/MM/yyyy})"));
            
            ShowAlert("Multiple Trips Found", 
                $"Multiple trips found for {transaction.Email}:\n\n{tripOptions}\n\n" +
                $"Please use the Trip Suggestions page to link transactions, or navigate to Trips page and use 'Link Transactions' action.", 
                "Info");
        }
        catch (Exception ex)
        {
            ShowAlert("Error", $"An error occurred: {ex.Message}", "Error");
        }
    }

    private async Task SplitTransaction(Transaction transaction)
    {
        selectedTransactionForSplit = transaction;
        showSplitModal = true;
        StateHasChanged();
    }
    
    private void CloseSplitModal()
    {
        showSplitModal = false;
        selectedTransactionForSplit = null;
        StateHasChanged();
    }
    
    private async Task OnSplitSaved(List<SplitItem> splitItems)
    {
        try
        {
            // The split logic should be handled in the service layer
            ShowAlert("Success", "Transaction split successfully!", "Success");
            showSplitModal = false;
            selectedTransactionForSplit = null;
            await RefreshTransactions();
        }
        catch (Exception ex)
        {
            ShowAlert("Error", $"Failed to split transaction: {ex.Message}", "Error");
        }
    }

    private async Task GenerateMessage(Transaction transaction)
    {
        try
        {
            string message = "";
            
            // Generate message based on transaction category and issues
            if (transaction.Category?.Name == "Meals" && transaction.AmountUSD >= 80)
            {
                // Parse participants if available
                List<string>? participants = null;
                if (!string.IsNullOrEmpty(transaction.Participants))
                {
                    participants = transaction.Participants.Split(',')
                        .Select(p => p.Trim())
                        .Where(p => !string.IsNullOrEmpty(p))
                        .ToList();
                }
                message = MessageTemplateService.GenerateMealsMessage(transaction, participants);
            }
            else if (transaction.Category?.Name == "Client entertainment")
            {
                // Parse participants
                List<string> participants = new();
                if (!string.IsNullOrEmpty(transaction.Participants))
                {
                    participants = transaction.Participants.Split(',')
                        .Select(p => p.Trim())
                        .Where(p => !string.IsNullOrEmpty(p))
                        .ToList();
                }
                message = MessageTemplateService.GenerateClientEntertainmentMessage(transaction, participants);
            }
            else if (transaction.Category?.Name == "Other" || transaction.Category == null)
            {
                message = MessageTemplateService.GenerateOtherCategoryMessage(transaction, transaction.Trip);
            }
            else if (string.IsNullOrEmpty(transaction.DocumentUrl))
            {
                message = MessageTemplateService.GenerateDocumentationMessage(transaction);
            }
            else
            {
                // Default message for other cases
                message = $"Hi {transaction.Email?.Split('@')[0] ?? "User"},\n\n" +
                         $"Regarding transaction {transaction.TransactionId}:\n" +
                         $"Date: {transaction.TransactionDate:dd/MM/yyyy}\n" +
                         $"Vendor: {transaction.Vendor}\n" +
                         $"Amount: {transaction.Currency} {transaction.Amount:N2}\n\n" +
                         $"Please provide any additional information needed for this transaction.\n\n" +
                         $"Thank you!";
            }
            
            // Copy to clipboard
            await JSRuntime.InvokeVoidAsync("navigator.clipboard.writeText", message);
            ShowAlert("Success", "‚úÖ Message copied to clipboard!\n\nYou can now paste it into your email client.", "Success");
        }
        catch (Exception ex)
        {
            ShowAlert("Error", $"Failed to generate message: {ex.Message}", "Error");
        }
    }

    private async Task ViewDocuments(Transaction transaction)
    {
        if (!string.IsNullOrEmpty(transaction.DocumentUrl))
        {
            await JSRuntime.InvokeVoidAsync("window.open", transaction.DocumentUrl, "_blank");
        }
        else
        {
            ShowAlert("No Documents", "No documents available for this transaction", "Warning");
        }
    }

    private async Task MarkAsValid(Transaction transaction)
    {
        try
        {
            await TransactionService.MarkAsValidAsync(transaction.TransactionId);
            await RefreshTransactions();
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("console.error", "Failed to mark transaction as valid:", ex.Message);
        }
    }

    private async Task DeleteTransaction(Transaction transaction)
    {
        ShowConfirm(
            "Delete Transaction",
            $"Are you sure you want to delete transaction {transaction.TransactionId}?\n\nThis action cannot be undone.",
            async () =>
            {
                try
                {
                    await TransactionService.DeleteAsync(transaction.TransactionId);
                    await RefreshTransactions();
                    ShowAlert("Success", "Transaction deleted successfully", "Success");
                }
                catch (Exception ex)
                {
                    ShowAlert("Error", $"Failed to delete transaction: {ex.Message}", "Error");
                }
            },
            icon: "üóëÔ∏è",
            confirmText: "Delete",
            cancelText: "Cancel",
            confirmClass: "btn-error"
        );
    }

    private void CreateTransaction()
    {
        // Open the create modal for adding a new transaction
        if (createModal != null)
        {
            createModal.Show();
        }
        else
        {
            ShowAlert("Error", "Create modal component not initialized. Please refresh the page.", "Error");
        }
    }

    private void ClearTripFilter()
    {
        Navigation.NavigateTo("/transactions");
    }

    private async Task ImportTransactions()
    {
        Navigation.NavigateTo("/settings/csv-import");
    }

    private async Task ExportTransactions()
    {
        // TODO: Implement export functionality
        ShowAlert("Coming Soon", "Export functionality coming soon", "Info");
    }
    
    // Link to Trip modal handlers
    private void CloseLinkModal()
    {
        showLinkModal = false;
        selectedTripIdForLink = 0;
        selectedTripForLink = null;
        StateHasChanged();
    }

    private async Task OnTransactionsLinked()
    {
        // Refresh the transactions list after linking
        await RefreshTransactions();
        CloseLinkModal();
    }

    // Bulk actions
    private async Task BulkLinkToTrip()
    {
        try
        {
            if (!selectedTransactions.Any())
            {
                ShowAlert("No Selection", "Please select at least one transaction.", "Warning");
                return;
            }

            // Get the first transaction's email (for finding trips)
            var firstTransaction = filteredTransactions.FirstOrDefault(t => selectedTransactions.Contains(t.TransactionId));
            if (firstTransaction == null)
            {
                ShowAlert("Error", "Could not find selected transaction.", "Error");
                return;
            }

            // Validate email exists
            if (string.IsNullOrEmpty(firstTransaction.Email))
            {
                ShowAlert("Missing Email", "Selected transaction does not have an email address.", "Error");
                return;
            }

            // Check if all selected transactions have the same email
            var selectedTransactionList = filteredTransactions.Where(t => selectedTransactions.Contains(t.TransactionId)).ToList();
            var emails = selectedTransactionList.Select(t => t.Email).Where(e => !string.IsNullOrEmpty(e)).Distinct().ToList();
            
            if (emails.Count == 0)
            {
                ShowAlert("Missing Email", "Selected transactions do not have email addresses.", "Error");
                return;
            }
            
            if (emails.Count > 1)
            {
                ShowAlert("Multiple Employees", 
                    $"Selected transactions belong to different employees: {string.Join(", ", emails)}\n\n" +
                    $"Please select transactions from the same employee only.", 
                    "Warning");
                return;
            }

            // Get all trips for the email
            var trips = await TripService.GetTripsByEmailAsync(firstTransaction.Email);
            
            if (!trips.Any())
            {
                ShowAlert("No Trips Found", 
                    $"No trips found for {firstTransaction.Email}.\n\n" +
                    $"Please create a trip first or use the Matching Engine to link transactions automatically.", 
                    "Warning");
                return;
            }

            // If only one trip, use it automatically
            if (trips.Count() == 1)
            {
                var trip = trips.First();
                selectedTripIdForLink = trip.TripId;
                selectedTripForLink = trip;
                showLinkModal = true;
                StateHasChanged();
                return;
            }

            // Multiple trips - show options
            var tripOptions = string.Join("\n", trips.Select(t => 
                $"‚Ä¢ {t.TripName} ({t.StartDate:dd/MM/yyyy} - {t.EndDate:dd/MM/yyyy})"));
            
            ShowAlert("Multiple Trips Found", 
                $"Multiple trips found for {firstTransaction.Email}:\n\n{tripOptions}\n\n" +
                $"Please use the Matching Engine for bulk operations with multiple trips, or navigate to Trips page and use 'Link Transactions' action.", 
                "Info");
        }
        catch (Exception ex)
        {
            ShowAlert("Error", $"An error occurred: {ex.Message}", "Error");
        }
    }

    private async Task BulkMarkValid()
    {
        try
        {
            foreach (var transactionId in selectedTransactions)
            {
                await TransactionService.MarkAsValidAsync(transactionId);
            }
            await RefreshTransactions();
            ClearSelection();
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("console.error", "Failed to mark transactions as valid:", ex.Message);
        }
    }

    private async Task BulkExport()
    {
        // TODO: Implement bulk export
        ShowAlert("Coming Soon", $"Export {selectedTransactions.Count} transactions", "Info");
    }

    // Helper method to close dropdown menus
    private async Task CloseDropdown()
    {
        // Remove focus from active element to close dropdown
        await JSRuntime.InvokeVoidAsync("eval", "document.activeElement?.blur()");
    }

    // Helper method to get color class for source
    private string GetSourceColor(string sourceName)
    {
        return sourceName?.ToLower() switch
        {
            "navan" => "text-blue-600",
            "agent" => "text-purple-600",
            "manual" => "text-orange-600",
            _ => "text-gray-600"
        };
    }

    // Helper method to get color class for category
    private string GetCategoryColor(string categoryName)
    {
        return categoryName?.ToLower() switch
        {
            "airfare" => "text-blue-600",
            "lodging" => "text-purple-600",
            "meals" => "text-green-600",
            "transportation" => "text-yellow-600",
            "communication" => "text-cyan-600",
            "client entertainment" => "text-pink-600",
            "other" => "text-gray-600",
            "non-travel" => "text-red-600",
            _ => "text-gray-600"
        };
    }

    // Helper method to get color class for cabin class
    private string GetCabinClassColor(string cabinClassName)
    {
        return cabinClassName?.ToLower() switch
        {
            "economy" => "text-green-600",
            "premium economy" => "text-blue-600",
            "business" => "text-purple-600",
            "first" => "text-orange-600",
            _ => "text-gray-600"
        };
    }
    
    // AlertDialog Helper Methods
    private void ShowAlert(string title, string message, string type = "Info", string okText = "OK")
    {
        alertTitle = title;
        alertMessage = message;
        alertType = type switch
        {
            "Success" => AlertDialog.AlertType.Success,
            "Error" => AlertDialog.AlertType.Error,
            "Warning" => AlertDialog.AlertType.Warning,
            _ => AlertDialog.AlertType.Info
        };
        alertOkText = okText;
        showAlertDialog = true;
        StateHasChanged();
    }
    
    private void CloseAlertDialog()
    {
        showAlertDialog = false;
        StateHasChanged();
    }
    
    // ConfirmDialog Helper Methods
    private void ShowConfirm(string title, string message, Func<Task> onConfirm, 
        string icon = "‚ö†Ô∏è", string confirmText = "Confirm", string cancelText = "Cancel", 
        string confirmClass = "btn-primary")
    {
        confirmTitle = title;
        confirmMessage = message;
        confirmIcon = icon;
        confirmButtonText = confirmText;
        cancelButtonText = cancelText;
        confirmButtonClass = confirmClass;
        pendingConfirmAction = onConfirm;
        showConfirmDialog = true;
        StateHasChanged();
    }
    
    private async Task HandleConfirmResult(bool confirmed)
    {
        showConfirmDialog = false;
        
        if (confirmed && pendingConfirmAction != null)
        {
            await pendingConfirmAction.Invoke();
        }
        
        pendingConfirmAction = null;
        StateHasChanged();
    }
}