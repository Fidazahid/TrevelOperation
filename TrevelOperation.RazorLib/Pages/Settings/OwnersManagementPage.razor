@page "/settings/owners"
@using TravelOperation.Core.Models.Entities
@using TrevelOperation.Service
@using TravelOperation.Core.Services.Interfaces
@using TrevelOperation.RazorLib.Components
@inject IJSRuntime JSRuntime
@inject ISettingsService SettingsService
@inject ITripService TripService

<PageTitle>Owners - Travel Expense Management</PageTitle>

<AuthorizeRoleView RequiredRole="Finance">
<div class="p-6">
    <div class="mb-6">
        <h1 class="text-3xl font-bold text-base-content mb-2">Owners</h1>
        <p class="text-base-content/70">Manage trip owners and their organizational details for assignment and reporting</p>
    </div>

    <!-- Actions Bar -->
    <div class="bg-base-200 rounded-lg p-4 mb-6">
        <div class="flex flex-wrap gap-4 items-center justify-between">
            <div class="flex flex-wrap gap-4 items-center">
                <!-- Search -->
                <div class="form-control">
                    <input type="text" placeholder="Search owners..." 
                           class="input input-bordered w-64" @bind="searchTerm" @oninput="FilterOwners" />
                </div>
                
                <!-- Department Filter -->
                <div class="form-control">
                    <select class="select select-bordered" @bind="selectedDepartment" @bind:after="FilterOwners">
                        <option value="">All departments</option>
                        @foreach (var dept in GetDepartments())
                        {
                            <option value="@dept">@dept</option>
                        }
                    </select>
                </div>
                
                <!-- Domain Filter -->
                <div class="form-control">
                    <select class="select select-bordered" @bind="selectedDomain" @bind:after="FilterOwners">
                        <option value="">All domains</option>
                        @foreach (var domain in GetDomains())
                        {
                            <option value="@domain">@domain</option>
                        }
                    </select>
                </div>
                
                <!-- Status Filter -->
                <div class="form-control">
                    <select class="select select-bordered" @bind="selectedStatus" @bind:after="FilterOwners">
                        <option value="">All statuses</option>
                        <option value="true">Active</option>
                        <option value="false">Inactive</option>
                    </select>
                </div>
            </div>
            
            <div class="flex gap-2">
                <button class="btn btn-secondary" @onclick="ImportFromHeadcount">
                    üì• Sync Headcount
                </button>
                <button class="btn btn-primary" @onclick="ShowAddModal">
                    ‚ûï Add Owner
                </button>
                <button class="btn btn-outline" @onclick="ExportOwners">
                    üìÑ Export CSV
                </button>
            </div>
        </div>
    </div>

    <!-- Owners Table -->
    <div class="bg-base-100 rounded-lg shadow-lg overflow-hidden">
        <div class="overflow-x-auto">
            <table class="table table-zebra w-full">
                <thead class="bg-base-300">
                    <tr>
                        <th class="cursor-pointer" @onclick='() => SortBy("Name")'>
                            Name
                            @if (sortColumn == "Name")
                            {
                                <span class="ml-2">@(sortAscending ? "‚Üë" : "‚Üì")</span>
                            }
                        </th>
                        <th class="cursor-pointer" @onclick='() => SortBy("Email")'>
                            Email
                            @if (sortColumn == "Email")
                            {
                                <span class="ml-2">@(sortAscending ? "‚Üë" : "‚Üì")</span>
                            }
                        </th>
                        <th class="cursor-pointer" @onclick='() => SortBy("Department")'>
                            Department
                            @if (sortColumn == "Department")
                            {
                                <span class="ml-2">@(sortAscending ? "‚Üë" : "‚Üì")</span>
                            }
                        </th>
                        <th>Domain</th>
                        <th>Cost Center</th>
                        <th>Trip Count</th>
                        <th>Last Activity</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @if (filteredOwners.Any())
                    {
                        @foreach (var owner in filteredOwners.Skip((currentPage - 1) * pageSize).Take(pageSize))
                        {
                            <tr class="hover">
                                <td>
                                    <div class="flex items-center gap-3">
                                        <div class="avatar placeholder">
                                            <div class="bg-neutral text-neutral-content rounded-full w-10">
                                                <span class="text-sm">@GetInitials(owner.Name)</span>
                                            </div>
                                        </div>
                                        <div>
                                            <div class="font-bold">@owner.Name</div>
                                            @if (!string.IsNullOrEmpty(owner.Title))
                                            {
                                                <div class="text-sm opacity-50">@owner.Title</div>
                                            }
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <a href="mailto:@owner.Email" class="link link-primary">@owner.Email</a>
                                </td>
                                <td>
                                    <span class="badge badge-outline">@owner.Department</span>
                                </td>
                                <td>
                                    <span class="badge badge-neutral">@owner.Domain</span>
                                </td>
                                <td>
                                    <span class="font-mono text-sm">@owner.CostCenter</span>
                                </td>
                                <td>
                                    <div class="text-center">
                                        <span class="badge badge-info">@owner.TripCount</span>
                                        <div class="text-xs text-base-content/60">trips</div>
                                    </div>
                                </td>
                                <td>
                                    @if (owner.LastActivity.HasValue)
                                    {
                                        <span class="text-sm">@owner.LastActivity.Value.ToString("dd/MM/yyyy")</span>
                                        <div class="text-xs text-base-content/60">
                                            @GetRelativeTime(owner.LastActivity.Value)
                                        </div>
                                    }
                                    else
                                    {
                                        <span class="text-base-content/50">No activity</span>
                                    }
                                </td>
                                <td>
                                    @if (owner.IsActive)
                                    {
                                        <span class="badge badge-success">Active</span>
                                    }
                                    else
                                    {
                                        <span class="badge badge-error">Inactive</span>
                                    }
                                </td>
                                <td>
                                    <div class="dropdown dropdown-end">
                                        <label tabindex="0" class="btn btn-ghost btn-sm">‚ãÆ</label>
                                        <ul tabindex="0" class="dropdown-content menu p-2 shadow bg-base-200 rounded-box w-48">
                                            <li><a @onclick="@(() => EditOwner(owner))">‚úèÔ∏è Edit</a></li>
                                            <li><a @onclick="@(() => ViewTrips(owner))">üß≥ View Trips</a></li>
                                            <li><a @onclick="@(() => ToggleOwnerStatus(owner))">
                                                @(owner.IsActive ? "‚è∏Ô∏è Deactivate" : "‚ñ∂Ô∏è Activate")
                                            </a></li>
                                            <li><a @onclick="@(() => SendEmail(owner))">üìß Send Email</a></li>
                                            <li><a @onclick="@(() => DeleteOwner(owner))" class="text-error">üóëÔ∏è Delete</a></li>
                                        </ul>
                                    </div>
                                </td>
                            </tr>
                        }
                    }
                    else
                    {
                        <tr>
                            <td colspan="9" class="text-center py-8 text-base-content/60">
                                @if (string.IsNullOrEmpty(searchTerm) && string.IsNullOrEmpty(selectedDepartment))
                                {
                                    <span>No owners configured. Click "Add Owner" or "Sync Headcount" to get started.</span>
                                }
                                else
                                {
                                    <span>No owners found matching your criteria.</span>
                                }
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
        
        <!-- Pagination -->
        @if (filteredOwners.Count() > pageSize)
        {
            <div class="flex justify-between items-center p-4 bg-base-200">
                <div class="text-sm text-base-content/70">
                    Showing @Math.Min(pageSize, filteredOwners.Count()) of @filteredOwners.Count() owners
                </div>
                <div class="btn-group">
                    <button class="btn btn-sm" disabled="@(currentPage == 1)" @onclick="PreviousPage">‚ùÆ</button>
                    <span class="btn btn-sm btn-active">@currentPage</span>
                    <button class="btn btn-sm" disabled="@(currentPage * pageSize >= filteredOwners.Count())" @onclick="NextPage">‚ùØ</button>
                </div>
            </div>
        }
    </div>
</div>

<!-- Add/Edit Modal -->
@if (showModal)
{
    <div class="modal modal-open">
        <div class="modal-box max-w-2xl">
            <h3 class="font-bold text-lg mb-4">@(isEditing ? "Edit" : "Add") Owner</h3>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div class="form-control">
                    <label class="label">
                        <span class="label-text">Full Name *</span>
                    </label>
                    <input type="text" class="input input-bordered" @bind="editingOwner.Name" 
                           placeholder="John Doe" />
                </div>
                
                <div class="form-control">
                    <label class="label">
                        <span class="label-text">Email *</span>
                    </label>
                    <input type="email" class="input input-bordered" @bind="editingOwner.Email" 
                           placeholder="john.doe@company.com" />
                </div>
            </div>
            
            <div class="form-control mb-4">
                <label class="label">
                    <span class="label-text">Job Title</span>
                </label>
                <input type="text" class="input input-bordered" @bind="editingOwner.Title" 
                       placeholder="Senior Software Engineer" />
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div class="form-control">
                    <label class="label">
                        <span class="label-text">Department *</span>
                    </label>
                    <select class="select select-bordered" @bind="editingOwner.Department">
                        <option value="">Select department...</option>
                        <option value="Engineering">Engineering</option>
                        <option value="Sales">Sales</option>
                        <option value="Marketing">Marketing</option>
                        <option value="Product">Product</option>
                        <option value="Operations">Operations</option>
                        <option value="Finance">Finance</option>
                        <option value="HR">HR</option>
                        <option value="Customer Success">Customer Success</option>
                        <option value="Business Development">Business Development</option>
                        <option value="Legal">Legal</option>
                    </select>
                </div>
                
                <div class="form-control">
                    <label class="label">
                        <span class="label-text">Domain *</span>
                    </label>
                    <select class="select select-bordered" @bind="editingOwner.Domain">
                        <option value="">Select domain...</option>
                        <option value="R&D">R&D</option>
                        <option value="Go-to-Market">Go-to-Market</option>
                        <option value="Operations">Operations</option>
                        <option value="Corporate">Corporate</option>
                    </select>
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div class="form-control">
                    <label class="label">
                        <span class="label-text">Cost Center</span>
                    </label>
                    <input type="text" class="input input-bordered" @bind="editingOwner.CostCenter" 
                           placeholder="CC-ENG-001" />
                </div>
                
                <div class="form-control">
                    <label class="label">
                        <span class="label-text">Manager Email</span>
                    </label>
                    <input type="email" class="input input-bordered" @bind="editingOwner.ManagerEmail" 
                           placeholder="manager@company.com" />
                </div>
            </div>
            
            <div class="form-control mb-4">
                <label class="cursor-pointer label">
                    <input type="checkbox" class="checkbox" @bind="editingOwner.IsActive" />
                    <span class="label-text ml-2">Active owner (can be assigned to trips)</span>
                </label>
            </div>
            
            <div class="form-control mb-4">
                <label class="label">
                    <span class="label-text">Notes</span>
                </label>
                <textarea class="textarea textarea-bordered" @bind="editingOwner.Notes" 
                          placeholder="Optional notes about this owner"></textarea>
            </div>
            
            <div class="modal-action">
                <button class="btn btn-ghost" @onclick="HideModal">Cancel</button>
                <button class="btn btn-primary" @onclick="SaveOwner" 
                        disabled="@(string.IsNullOrWhiteSpace(editingOwner.Name) || string.IsNullOrWhiteSpace(editingOwner.Email) || string.IsNullOrWhiteSpace(editingOwner.Department) || string.IsNullOrWhiteSpace(editingOwner.Domain))">
                    @(isEditing ? "Update" : "Add") Owner
                </button>
            </div>
        </div>
    </div>
}

<!-- Trips Modal -->
@if (showTripsModal && selectedOwner != null)
{
    <div class="modal modal-open">
        <div class="modal-box max-w-4xl">
            <h3 class="font-bold text-lg mb-4">Trips for @selectedOwner.Name</h3>
            
            @if (ownerTrips.Any())
            {
                <div class="overflow-x-auto">
                    <table class="table table-zebra w-full">
                        <thead>
                            <tr>
                                <th>Trip Name</th>
                                <th>Dates</th>
                                <th>Destination</th>
                                <th>Status</th>
                                <th>Purpose</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var trip in ownerTrips)
                            {
                                <tr>
                                    <td>@trip.TripName</td>
                                    <td>@trip.StartDate.ToString("dd/MM/yyyy") - @trip.EndDate.ToString("dd/MM/yyyy")</td>
                                    <td>@trip.City1, @trip.Country1</td>
                                    <td><span class="badge @GetTripStatusBadge(trip.Status)">@trip.Status?.Name</span></td>
                                    <td>@trip.Purpose?.Name</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
            else
            {
                <div class="text-center py-8 text-base-content/60">
                    No trips found for this owner.
                </div>
            }
            
            <div class="modal-action">
                <button class="btn btn-ghost" @onclick="HideTripsModal">Close</button>
            </div>
        </div>
    </div>
}

@code {
    private List<OwnerDisplay> owners = new();
    private IEnumerable<OwnerDisplay> filteredOwners = new List<OwnerDisplay>();
    
    private string searchTerm = "";
    private string selectedDepartment = "";
    private string selectedDomain = "";
    private string selectedStatus = "";
    
    private string sortColumn = "Name";
    private bool sortAscending = true;
    
    private int currentPage = 1;
    private int pageSize = 20;
    
    // Modal state
    private bool showModal = false;
    private bool isEditing = false;
    private Owner editingOwner = new();
    
    // Trips modal state
    private bool showTripsModal = false;
    private OwnerDisplay? selectedOwner;
    private List<Trip> ownerTrips = new();
    
    private bool isLoading = false;
    private string? errorMessage;

    protected override async Task OnInitializedAsync()
    {
        await LoadOwners();
    }

    private async Task LoadOwners()
    {
        try
        {
            isLoading = true;
            errorMessage = null;
            
            var ownerEntities = await SettingsService.GetOwnersAsync();
            var allTrips = await TripService.GetAllTripsAsync();
            
            // Create display objects with calculated fields
            owners = ownerEntities.Select(o => new OwnerDisplay
            {
                OwnerId = o.OwnerId,
                Name = o.Name,
                Email = o.Email,
                Department = o.Department ?? "Not set",
                Domain = o.Domain ?? "Not set",
                CostCenter = o.CostCenter ?? "Not set",
                Title = "", // Not in database
                IsActive = true, // Not in database, default to true
                TripCount = allTrips.Count(t => t.OwnerId == o.OwnerId),
                LastActivity = allTrips.Where(t => t.OwnerId == o.OwnerId)
                    .OrderByDescending(t => t.ModifiedAt)
                    .FirstOrDefault()?.ModifiedAt
            }).ToList();
            
            FilterOwners();
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading owners: {ex.Message}";
            Console.WriteLine($"Error: {ex}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private void FilterOwners()
    {
        filteredOwners = owners.AsEnumerable();

        if (!string.IsNullOrEmpty(searchTerm))
        {
            filteredOwners = filteredOwners.Where(o => 
                o.Name.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ||
                o.Email.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ||
                (o.Title?.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ?? false));
        }

        if (!string.IsNullOrEmpty(selectedDepartment))
        {
            filteredOwners = filteredOwners.Where(o => o.Department == selectedDepartment);
        }

        if (!string.IsNullOrEmpty(selectedDomain))
        {
            filteredOwners = filteredOwners.Where(o => o.Domain == selectedDomain);
        }

        if (!string.IsNullOrEmpty(selectedStatus))
        {
            var isActive = bool.Parse(selectedStatus);
            filteredOwners = filteredOwners.Where(o => o.IsActive == isActive);
        }

        // Apply sorting
        if (sortColumn == "Name")
        {
            filteredOwners = sortAscending 
                ? filteredOwners.OrderBy(o => o.Name)
                : filteredOwners.OrderByDescending(o => o.Name);
        }
        else if (sortColumn == "Email")
        {
            filteredOwners = sortAscending 
                ? filteredOwners.OrderBy(o => o.Email)
                : filteredOwners.OrderByDescending(o => o.Email);
        }
        else if (sortColumn == "Department")
        {
            filteredOwners = sortAscending 
                ? filteredOwners.OrderBy(o => o.Department)
                : filteredOwners.OrderByDescending(o => o.Department);
        }

        currentPage = 1;
        StateHasChanged();
    }

    private void SortBy(string columnName)
    {
        if (sortColumn == columnName)
        {
            sortAscending = !sortAscending;
        }
        else
        {
            sortColumn = columnName;
            sortAscending = true;
        }
        FilterOwners();
    }

    private void PreviousPage()
    {
        if (currentPage > 1)
        {
            currentPage--;
            StateHasChanged();
        }
    }

    private void NextPage()
    {
        if (currentPage * pageSize < filteredOwners.Count())
        {
            currentPage++;
            StateHasChanged();
        }
    }

    private IEnumerable<string> GetDepartments()
    {
        return owners.Select(o => o.Department).Distinct().OrderBy(d => d);
    }

    private IEnumerable<string> GetDomains()
    {
        return owners.Select(o => o.Domain).Distinct().OrderBy(d => d);
    }

    private string GetInitials(string name)
    {
        var parts = name.Split(' ', StringSplitOptions.RemoveEmptyEntries);
        if (parts.Length >= 2)
        {
            return $"{parts[0][0]}{parts[^1][0]}".ToUpper();
        }
        return parts.Length > 0 ? parts[0][0].ToString().ToUpper() : "?";
    }

    private string GetRelativeTime(DateTime date)
    {
        var diff = DateTime.Today - date.Date;
        return diff.Days switch
        {
            0 => "Today",
            1 => "Yesterday",
            < 7 => $"{diff.Days} days ago",
            < 30 => $"{diff.Days / 7} weeks ago",
            < 365 => $"{diff.Days / 30} months ago",
            _ => $"{diff.Days / 365} years ago"
        };
    }

    private void ShowAddModal()
    {
        editingOwner = new Owner();
        isEditing = false;
        showModal = true;
    }

    private void EditOwner(OwnerDisplay owner)
    {
        editingOwner = new Owner
        {
            OwnerId = owner.OwnerId,
            Name = owner.Name,
            Email = owner.Email,
            Department = owner.Department,
            Domain = owner.Domain,
            CostCenter = owner.CostCenter
        };
        isEditing = true;
        showModal = true;
    }

    private async Task SaveOwner()
    {
        if (string.IsNullOrWhiteSpace(editingOwner.Name) || string.IsNullOrWhiteSpace(editingOwner.Email))
            return;

        try
        {
            if (isEditing)
            {
                await SettingsService.UpdateOwnerAsync(
                    editingOwner.OwnerId,
                    editingOwner.Name.Trim(),
                    editingOwner.Email.Trim().ToLower(),
                    editingOwner.CostCenter?.Trim(),
                    editingOwner.Department?.Trim(),
                    editingOwner.Domain?.Trim());
            }
            else
            {
                await SettingsService.CreateOwnerAsync(
                    editingOwner.Name.Trim(),
                    editingOwner.Email.Trim().ToLower(),
                    editingOwner.CostCenter?.Trim(),
                    editingOwner.Department?.Trim(),
                    editingOwner.Domain?.Trim());
            }

            HideModal();
            await LoadOwners();
            await JSRuntime.InvokeVoidAsync("alert", $"Owner {(isEditing ? "updated" : "added")} successfully!");
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"Error saving owner: {ex.Message}");
        }
    }

    private async Task DeleteOwner(OwnerDisplay owner)
    {
        bool confirmed = await JSRuntime.InvokeAsync<bool>("confirm", 
            $"Delete owner '{owner.Name}'? This action cannot be undone and may affect trip assignments.");
        
        if (confirmed)
        {
            try
            {
                await SettingsService.DeleteOwnerAsync(owner.OwnerId);
                await LoadOwners();
                await JSRuntime.InvokeVoidAsync("alert", "Owner deleted successfully!");
            }
            catch (Exception ex)
            {
                await JSRuntime.InvokeVoidAsync("alert", $"Error deleting owner: {ex.Message}");
            }
        }
    }

    private void ToggleOwnerStatus(OwnerDisplay owner)
    {
        // IsActive is not in database, so this is just UI toggle for now
        owner.IsActive = !owner.IsActive;
        StateHasChanged();
    }

    private async Task ViewTrips(OwnerDisplay owner)
    {
        selectedOwner = owner;
        try
        {
            // Load actual trips for this owner
            ownerTrips = (await TripService.GetAllTripsAsync())
                .Where(t => t.OwnerId == owner.OwnerId)
                .OrderByDescending(t => t.StartDate)
                .ToList();
            showTripsModal = true;
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"Error loading trips: {ex.Message}");
        }
    }

    private async Task SendEmail(OwnerDisplay owner)
    {
        var emailUrl = $"mailto:{owner.Email}?subject=Travel%20Expense%20Management";
        await JSRuntime.InvokeVoidAsync("open", emailUrl, "_blank");
    }

    private void HideModal()
    {
        showModal = false;
        editingOwner = new Owner();
    }

    private void HideTripsModal()
    {
        showTripsModal = false;
        selectedOwner = null;
        ownerTrips.Clear();
    }

    private async Task ImportFromHeadcount()
    {
        bool confirmed = await JSRuntime.InvokeAsync<bool>("confirm", 
            "Sync with headcount data? This will create owners from unique emails in headcount table.");
        
        if (confirmed)
        {
            try
            {
                var headcount = await SettingsService.GetHeadcountAsync();
                var existingEmails = owners.Select(o => o.Email.ToLower()).ToHashSet();
                var addedCount = 0;
                
                foreach (var emp in headcount)
                {
                    if (!existingEmails.Contains(emp.Email.ToLower()))
                    {
                        await SettingsService.CreateOwnerAsync(
                            $"{emp.FirstName} {emp.LastName}",
                            emp.Email,
                            emp.CostCenter,
                            emp.Department,
                            emp.Domain);
                        addedCount++;
                    }
                }
                
                await LoadOwners();
                await JSRuntime.InvokeVoidAsync("alert", $"Synced {addedCount} new owners from headcount data!");
            }
            catch (Exception ex)
            {
                await JSRuntime.InvokeVoidAsync("alert", $"Error syncing headcount: {ex.Message}");
            }
        }
    }

    private async Task ExportOwners()
    {
        var csv = "Name,Email,Department,Domain,CostCenter,TripCount,LastActivity\n";
        foreach (var owner in owners.OrderBy(o => o.Name))
        {
            csv += $"\"{owner.Name}\",\"{owner.Email}\",\"{owner.Department}\",\"{owner.Domain}\",\"{owner.CostCenter}\",{owner.TripCount},{owner.LastActivity?.ToString("yyyy-MM-dd") ?? ""}\n";
        }
        
        await JSRuntime.InvokeVoidAsync("downloadFile", "owners.csv", "text/csv", csv);
    }

    private string GetTripStatusClass(string status)
    {
        return status switch
        {
            "Completed" => "badge-success",
            "Upcoming" => "badge-info",
            "Ongoing" => "badge-warning",
            "Canceled" => "badge-error",
            _ => "badge-neutral"
        };
    }

    private string GetTripStatusBadge(Status? status)
    {
        if (status == null) return "badge-neutral";
        
        return status.Name.ToLower() switch
        {
            "completed" => "badge-success",
            "upcoming" => "badge-info",
            "ongoing" => "badge-warning",
            "canceled" => "badge-error",
            _ => "badge-neutral"
        };
    }

    // Display wrapper class for UI (includes calculated fields)
    public class OwnerDisplay
    {
        public int OwnerId { get; set; }
        public string Name { get; set; } = "";
        public string Email { get; set; } = "";
        public string? Title { get; set; }
        public string Department { get; set; } = "";
        public string Domain { get; set; } = "";
        public string? CostCenter { get; set; }
        public bool IsActive { get; set; }
        public int TripCount { get; set; }
        public DateTime? LastActivity { get; set; }
    }
}
</AuthorizeRoleView>