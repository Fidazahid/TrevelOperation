@page "/trips"
@using TravelOperation.Core.Models.Entities
@using TravelOperation.Core.Models
@using TravelOperation.Core.Services.Interfaces
@inject ITripService TripService
@inject ILookupService LookupService
@inject IJSRuntime JSRuntime
@inject NavigationManager NavigationManager
@implements IDisposable

<PageTitle>Trips - Travel Expense Management</PageTitle>

<style>
    .table td, .table th {
        word-wrap: break-word;
        overflow-wrap: break-word;
        white-space: normal !important;
    }
</style>

<div class="container ">
    <div class="flex justify-between items-center ">
        <h1 class="text-3xl font-bold text-gray-900">Trips</h1>
        <div class="flex gap-2">
            <button class="btn btn-primary" @onclick="OpenCreateModal">
                <i class="fas fa-plus mr-2"></i>New Trip
            </button>
            <button class="btn btn-secondary" @onclick="SuggestTrips">
                <i class="fas fa-magic mr-2"></i>Suggest Trips
            </button>
            <button class="btn btn-outline" @onclick="ExportData">
                <i class="fas fa-download mr-2"></i>Export
            </button>
        </div>
    </div>

    <!-- Filters -->
    <div class="card bg-base-100 shadow-sm ">
        <div class="card-body">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <div class="form-control">
                    <label class="label">
                        <span class="label-text">Search</span>
                    </label>
                    <input type="text" placeholder="Trip name, email, destination..." 
                           class="input input-bordered" @bind="searchTerm" @onkeyup="FilterTrips" />
                </div>
                <div class="form-control">
                    <label class="label">
                        <span class="label-text">Purpose</span>
                    </label>
                    <select class="select select-bordered" @bind="selectedPurposeId" @oninput="FilterTrips">
                        <option value="">All Purposes</option>
                        @if (purposes != null)
                        {
                            @foreach (var purpose in purposes)
                            {
                                <option value="@purpose.PurposeId">@purpose.Emoji @purpose.Name</option>
                            }
                        }
                    </select>
                </div>
                <div class="form-control">
                    <label class="label">
                        <span class="label-text">Status</span>
                    </label>
                    <select class="select select-bordered" @bind="selectedStatusId" @oninput="FilterTrips">
                        <option value="">All Statuses</option>
                        @if (statuses != null)
                        {
                            @foreach (var status in statuses)
                            {
                                <option value="@status.StatusId">@status.Emoji @status.Name</option>
                            }
                        }
                    </select>
                </div>
                <div class="form-control">
                    <label class="label">
                        <span class="label-text">Owner</span>
                    </label>
                    <select class="select select-bordered" @bind="selectedOwnerId" @oninput="FilterTrips">
                        <option value="">All Owners</option>
                        @if (owners != null)
                        {
                            @foreach (var owner in owners)
                            {
                                <option value="@owner.OwnerId">@owner.Name</option>
                            }
                        }
                    </select>
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                <div class="form-control">
                    <label class="label">
                        <span class="label-text">Start Date From</span>
                    </label>
                    <input type="date" class="input input-bordered" @bind="startDateFrom" @oninput="FilterTrips" />
                </div>
                <div class="form-control">
                    <label class="label">
                        <span class="label-text">Start Date To</span>
                    </label>
                    <input type="date" class="input input-bordered" @bind="startDateTo" @oninput="FilterTrips" />
                </div>
            </div>
        </div>
    </div>

    <!-- Trips Table -->
    <div class="card bg-base-100 shadow-sm">
        <!-- Table with fixed height -->
        <div class="overflow-y-auto" style="height: 600px; overflow-x: hidden;">
            <table class="table table-zebra table-pin-rows" style="table-layout: fixed; width: 100%;">
                <thead class="bg-white sticky top-0 z-10">
                    <tr class="bg-white">
                        <th class="bg-white" style="width: 30px;">
                            <label>
                                <input type="checkbox" class="checkbox checkbox-sm" 
                                       checked="@isAllSelected"
                                       @onchange="@((ChangeEventArgs e) => ToggleSelectAllChange((bool)e.Value!))" />
                            </label>
                        </th>
                        <th class="bg-white cursor-pointer hover:bg-base-200" style="width: 100px;" @onclick='() => SortBy("TripName")'>
                            Trip Name 
                            @if (sortColumn == "TripName")
                            {
                                <span>@(sortAscending ? "â†‘" : "â†“")</span>
                            }
                        </th>
                        <th class="bg-white cursor-pointer hover:bg-base-200" style="width: 140px;" @onclick='() => SortBy("Email")'>
                            Email
                            @if (sortColumn == "Email")
                            {
                                <span>@(sortAscending ? "â†‘" : "â†“")</span>
                            }
                        </th>
                        <th class="bg-white cursor-pointer hover:bg-base-200" style="width: 85px;" @onclick='() => SortBy("StartDate")'>
                            Start
                            @if (sortColumn == "StartDate")
                            {
                                <span>@(sortAscending ? "â†‘" : "â†“")</span>
                            }
                        </th>
                        <th class="bg-white cursor-pointer hover:bg-base-200" style="width: 85px;" @onclick='() => SortBy("EndDate")'>
                            End
                            @if (sortColumn == "EndDate")
                            {
                                <span>@(sortAscending ? "â†‘" : "â†“")</span>
                            }
                        </th>
                        <th class="bg-white" style="width: 90px;">Duration</th>
                        <th class="bg-white" style="width: 130px;">Destination</th>
                        <th class="bg-white" style="width: 100px;">Purpose</th>
                        <th class="bg-white" style="width: 90px;">Status</th>
                        <th class="bg-white" style="width: 90px;">Validation</th>
                        <th class="bg-white" style="width: 100px;">Owner</th>
                        <th class="bg-white" style="width: 100px;">Actions</th>
                    </tr>
                </thead>
                    <tbody>
                        @if (pagedResult.Items.Any())
                        {
                            @foreach (var trip in pagedResult.Items)
                            {
                                <tr class="hover" @ondblclick="() => ViewTripDetails(trip.TripId)">
                                    <td @onclick:stopPropagation="true">
                                        <label>
                                            <input type="checkbox" class="checkbox checkbox-sm" 
                                                   checked="@selectedTripIds.Contains(trip.TripId)"
                                                   @onchange="@((ChangeEventArgs e) => ToggleSelectionChange(trip.TripId, (bool)e.Value!))" />
                                        </label>
                                    </td>
                                    <td class="font-medium">@trip.TripName</td>
                                    <td>@trip.Email</td>
                                    <td>@trip.StartDate.ToString("dd/MM/yyyy")</td>
                                    <td>@trip.EndDate.ToString("dd/MM/yyyy")</td>
                                    <td>@trip.Duration days</td>
                                    <td>
                                        @if (!string.IsNullOrEmpty(trip.City1) && !string.IsNullOrEmpty(trip.Country1))
                                        {
                                            @($"{trip.City1}, {trip.Country1}")
                                        }
                                        else if (!string.IsNullOrEmpty(trip.Country1))
                                        {
                                            @trip.Country1
                                        }
                                        @if (!string.IsNullOrEmpty(trip.City2) && !string.IsNullOrEmpty(trip.Country2))
                                        {
                                            <br />@($"{trip.City2}, {trip.Country2}")
                                        }
                                        else if (!string.IsNullOrEmpty(trip.Country2))
                                        {
                                            <br />@trip.Country2
                                        }
                                    </td>
                                    <td>
                                        @if (trip.Purpose != null)
                                        {
                                            <span class="text-sm font-medium @GetPurposeColor(trip.Purpose.Name)">@trip.Purpose.Name</span>
                                        }
                                    </td>
                                    <td>
                                        @if (trip.Status != null)
                                        {
                                            <span class="text-sm font-medium @GetStatusColor(trip.Status.Name)">@trip.Status.Name</span>
                                        }
                                    </td>
                                    <td>
                                        @if (trip.ValidationStatus != null)
                                        {
                                            <span class="text-sm font-medium @GetValidationColor(trip.ValidationStatus.Name)">@trip.ValidationStatus.Name</span>
                                        }
                                    </td>
                                    <td>@trip.Owner?.Name</td>
                                    <td>
                                        <div class="dropdown dropdown-end">
                                            <button tabindex="0" class="w-8 h-8 rounded-full hover:bg-gray-100 flex items-center justify-center text-gray-600 hover:text-gray-900">
                                                â‹®
                                            </button>
                                            <ul tabindex="0" class="dropdown-content menu bg-base-100 rounded-box z-[1] w-52 p-2 shadow border border-base-300">
                                                <li><a @onclick="() => ViewTripDetails(trip.TripId)" class="hover:bg-base-200">
                                                    <i class="fas fa-eye mr-2"></i>View Details
                                                </a></li>
                                                <li><a @onclick="() => EditTrip(trip)" class="hover:bg-base-200">
                                                    <i class="fas fa-edit mr-2"></i>Edit
                                                </a></li>
                                                <li><a @onclick="() => LinkTransactions(trip.TripId)" class="hover:bg-base-200">
                                                    <i class="fas fa-link mr-2"></i>Link Transactions
                                                </a></li>
                                                @if (trip.ValidationStatus?.Name == "Ready to validate")
                                                {
                                                    <li><a @onclick="() => ValidateTrip(trip.TripId)" class="hover:bg-base-200">
                                                        <i class="fas fa-check mr-2"></i>Validate
                                                    </a></li>
                                                }
                                                <li><a @onclick="() => DeleteTrip(trip.TripId)" class="text-red-600 hover:bg-red-50">
                                                    <i class="fas fa-trash mr-2"></i>Delete
                                                </a></li>
                                            </ul>
                                        </div>
                                    </td>
                                </tr>
                            }
                        }
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Pagination - Outside the scrolling area -->
        @if (pagedResult.TotalCount > 0)
        {
            <div class="card-body border-t">
                <div class="flex justify-between items-center">
                    <div class="flex items-center gap-4">
                        <div class="text-sm text-base-content/70">
                            Showing @((currentPage - 1) * pageSize + 1) to @Math.Min(currentPage * pageSize, pagedResult.TotalCount) of @pagedResult.TotalCount trips
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="text-sm text-base-content/70">Per page:</span>
                            <select class="select select-bordered select-sm w-20" @bind="pageSize" @bind:after="UpdatePagination">
                                <option value="25">25</option>
                                <option value="50">50</option>
                                <option value="100">100</option>
                            </select>
                        </div>
                    </div>
                    @if (pagedResult.TotalPages > 1)
                    {
                        <div class="join">
                            <button class="join-item btn btn-sm" @onclick="() => ChangePage(currentPage - 1)" disabled="@(currentPage == 1)">
                                Â« Previous
                            </button>
                            @for (int i = Math.Max(1, currentPage - 2); i <= Math.Min(pagedResult.TotalPages, currentPage + 2); i++)
                            {
                                int pageNum = i;
                                <button class="join-item btn btn-sm @(currentPage == pageNum ? "btn-primary" : "")" 
                                        @onclick="() => ChangePage(pageNum)">
                                    @pageNum
                                </button>
                            }
                            <button class="join-item btn btn-sm" @onclick="() => ChangePage(currentPage + 1)" disabled="@(currentPage == pagedResult.TotalPages)">
                                Next Â»
                            </button>
                        </div>
                    }
                </div>
            </div>
        }
    </div>

    <!-- Bulk Actions (shown when trips are selected) -->
    @if (selectedTripIds.Any())
    {
        <div class="fixed bottom-4 right-4 bg-base-100 rounded-lg shadow-lg p-4 border z-[1000]">
            <div class="flex items-center gap-4">
                <span class="text-sm font-medium">@selectedTripIds.Count selected</span>
                <div class="flex gap-2">
                    <button class="btn btn-sm btn-primary" @onclick="BulkValidate">
                        <i class="fas fa-check mr-1"></i>Validate
                    </button>
                    <button class="btn btn-sm btn-outline" @onclick="BulkExport">
                        <i class="fas fa-download mr-1"></i>Export
                    </button>
                    <button class="btn btn-sm btn-error" @onclick="BulkDelete">
                        <i class="fas fa-trash mr-1"></i>Delete
                    </button>
                </div>
                <button class="btn btn-sm btn-ghost" @onclick="ClearSelection">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
    }


<!-- Trip Edit Modal -->
<TripEditModal IsVisible="showEditModal" 
               IsEditMode="isEditMode" 
               Trip="editingTrip" 
               OnClose="CloseEditModal" 
               OnSave="SaveTrip" />

<!-- Trip Suggestions Modal -->
<TripSuggestionsModal IsVisible="showSuggestionsModal"
                      Suggestions="tripSuggestions"
                      OnClose="CloseSuggestionsModal"
                      OnTripsCreated="OnTripsCreated" />

<!-- Link Transactions Modal -->
<LinkTransactionsModal IsVisible="showLinkModal" 
                       TripId="@(linkingTrip?.TripId ?? 0)" 
                       Trip="linkingTrip"
                       OnClose="CloseLinkModal" 
                       OnTransactionsLinked="OnTransactionsLinked" />

@code {
    private IEnumerable<Trip>? allTrips;
    private IEnumerable<Trip>? filteredTrips;
    private PagedResult<Trip> pagedResult = new();
    
    private IEnumerable<Purpose>? purposes;
    private IEnumerable<Status>? statuses;
    private IEnumerable<Owner>? owners;

    // Filtering
    private string searchTerm = "";
    private string selectedPurposeId = "";
    private string selectedStatusId = "";
    private string selectedOwnerId = "";
    private DateTime? startDateFrom;
    private DateTime? startDateTo;

    // Sorting
    private string sortColumn = "StartDate";
    private bool sortAscending = false;

    // Pagination
    private int currentPage = 1;
    private int pageSize = 25;

    // Selection
    private HashSet<int> selectedTripIds = new();
    private bool isAllSelected = false;

    // Modal state
    private bool showEditModal = false;
    private bool isEditMode = false;
    private Trip? editingTrip;

    // Suggestions modal state
    private bool showSuggestionsModal = false;
    private IEnumerable<Trip>? tripSuggestions;

    // Link transactions modal state
    private bool showLinkModal = false;
    private Trip? linkingTrip;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    public void Dispose()
    {
        // Force close modal when navigating away to prevent blocking other pages
        showEditModal = false;
        editingTrip = null;
        
        showSuggestionsModal = false;
        tripSuggestions = null;
        
        // Clear any selections
        selectedTripIds.Clear();
        isAllSelected = false;
    }

    private async Task LoadData()
    {
        allTrips = await TripService.GetAllTripsAsync();
        purposes = await LookupService.GetPurposesAsync();
        statuses = await LookupService.GetStatusesAsync();
        owners = await LookupService.GetOwnersAsync();
        
        await FilterTrips();
    }

    private async Task FilterTrips()
    {
        if (allTrips == null) return;

        var query = allTrips.AsQueryable();

        // Apply filters
        if (!string.IsNullOrEmpty(searchTerm))
        {
            query = query.Where(t => 
                (t.TripName != null && t.TripName.Contains(searchTerm, StringComparison.OrdinalIgnoreCase)) ||
                (t.Email != null && t.Email.Contains(searchTerm, StringComparison.OrdinalIgnoreCase)) ||
                (t.Country1 != null && t.Country1.Contains(searchTerm, StringComparison.OrdinalIgnoreCase)) ||
                (t.City1 != null && t.City1.Contains(searchTerm, StringComparison.OrdinalIgnoreCase)) ||
                (t.Country2 != null && t.Country2.Contains(searchTerm, StringComparison.OrdinalIgnoreCase)) ||
                (t.City2 != null && t.City2.Contains(searchTerm, StringComparison.OrdinalIgnoreCase)));
        }

        if (!string.IsNullOrEmpty(selectedPurposeId) && int.TryParse(selectedPurposeId, out var purposeId))
        {
            query = query.Where(t => t.PurposeId == purposeId);
        }

        if (!string.IsNullOrEmpty(selectedStatusId) && int.TryParse(selectedStatusId, out var statusId))
        {
            query = query.Where(t => t.StatusId == statusId);
        }

        if (!string.IsNullOrEmpty(selectedOwnerId) && int.TryParse(selectedOwnerId, out var ownerId))
        {
            query = query.Where(t => t.OwnerId == ownerId);
        }

        if (startDateFrom.HasValue)
        {
            query = query.Where(t => t.StartDate >= startDateFrom.Value);
        }

        if (startDateTo.HasValue)
        {
            query = query.Where(t => t.StartDate <= startDateTo.Value);
        }

        // Apply sorting
        query = sortColumn switch
        {
            "TripName" => sortAscending ? query.OrderBy(t => t.TripName) : query.OrderByDescending(t => t.TripName),
            "Email" => sortAscending ? query.OrderBy(t => t.Email) : query.OrderByDescending(t => t.Email),
            "StartDate" => sortAscending ? query.OrderBy(t => t.StartDate) : query.OrderByDescending(t => t.StartDate),
            "EndDate" => sortAscending ? query.OrderBy(t => t.EndDate) : query.OrderByDescending(t => t.EndDate),
            _ => query.OrderByDescending(t => t.StartDate)
        };

        filteredTrips = query.ToList();
        
        await UpdatePagination();
    }

    private async Task UpdatePagination()
    {
        if (filteredTrips == null) return;

        var totalCount = filteredTrips.Count();
        var pagedItems = filteredTrips
            .Skip((currentPage - 1) * pageSize)
            .Take(pageSize)
            .ToList();

        pagedResult = new PagedResult<Trip>(pagedItems, totalCount, currentPage, pageSize);

        // Update select all state when page changes
        UpdateSelectAllState();

        await InvokeAsync(StateHasChanged);
    }

    private async Task SortBy(string column)
    {
        if (sortColumn == column)
        {
            sortAscending = !sortAscending;
        }
        else
        {
            sortColumn = column;
            sortAscending = true;
        }

        await FilterTrips();
    }

    private async Task ChangePage(int page)
    {
        currentPage = page;
        await UpdatePagination();
    }

    private void ToggleSelectionChange(int tripId, bool isChecked)
    {
        if (isChecked)
        {
            selectedTripIds.Add(tripId);
        }
        else
        {
            selectedTripIds.Remove(tripId);
        }

        StateHasChanged();
        UpdateSelectAllState();
    }

    private void ToggleSelectAllChange(bool isChecked)
    {
        isAllSelected = isChecked;
        
        selectedTripIds.Clear();
        
        if (isAllSelected && pagedResult.Items != null)
        {
            foreach (var trip in pagedResult.Items)
            {
                selectedTripIds.Add(trip.TripId);
            }
        }
    }

    private void UpdateSelectAllState()
    {
        if (pagedResult.Items == null) return;
        
        var pageIds = pagedResult.Items.Select(t => t.TripId).ToHashSet();
        isAllSelected = pageIds.All(id => selectedTripIds.Contains(id)) && pageIds.Any();
        StateHasChanged();
    }

    private void ClearSelection()
    {
        selectedTripIds.Clear();
        isAllSelected = false;
        StateHasChanged();
    }

    // Helper methods for colored text
    private string GetPurposeColor(string purposeName)
    {
        return purposeName?.ToLower() switch
        {
            "business trip" => "text-blue-600",
            "onboarding" => "text-green-600",
            "company trip" => "text-purple-600",
            "bcp" => "text-orange-600",
            _ => "text-gray-600"
        };
    }

    private string GetStatusColor(string statusName)
    {
        // Remove emoji if present
        var name = statusName?.Replace("ðŸ”´", "").Replace("âšª", "").Replace("ðŸ”µ", "").Replace("ðŸŸ¢", "").Trim().ToLower();
        return name switch
        {
            "canceled" or "cancelled" => "text-red-600",
            "upcoming" => "text-gray-600",
            "ongoing" => "text-blue-600",
            "completed" => "text-green-600",
            _ => "text-gray-600"
        };
    }

    private string GetValidationColor(string validationName)
    {
        // Remove emoji if present
        var name = validationName?.Replace("âšª", "").Replace("ðŸŸ¡", "").Replace("ðŸŸ¢", "").Trim().ToLower();
        return name switch
        {
            "not ready to validate" => "text-gray-600",
            "ready to validate" => "text-yellow-600",
            "validated" => "text-green-600",
            _ => "text-gray-600"
        };
    }

    // Modal and CRUD operations
    private void OpenCreateModal()
    {
        editingTrip = new Trip
        {
            StartDate = DateTime.Today,
            EndDate = DateTime.Today.AddDays(1),
            CreatedAt = DateTime.UtcNow,
            ModifiedAt = DateTime.UtcNow,
            IsManual = true
        };
        isEditMode = false;
        showEditModal = true;
    }

    private void EditTrip(Trip trip)
    {
        editingTrip = trip;
        isEditMode = true;
        showEditModal = true;
    }

    private void CloseEditModal()
    {
        showEditModal = false;
        editingTrip = null;
    }

    private async Task SaveTrip(Trip trip)
    {
        try
        {
            if (isEditMode)
            {
                await TripService.UpdateTripAsync(trip);
            }
            else
            {
                await TripService.CreateTripAsync(trip);
            }

            await LoadData();
            CloseEditModal();
            
            await JSRuntime.InvokeVoidAsync("showToast", "success", 
                isEditMode ? "Trip updated successfully" : "Trip created successfully");
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("showToast", "error", $"Error saving trip: {ex.Message}");
        }
    }

    private async Task DeleteTrip(int tripId)
    {
        var confirmed = await JSRuntime.InvokeAsync<bool>("confirm", 
            "Are you sure you want to delete this trip? This will unlink all associated transactions.");
        
        if (confirmed)
        {
            try
            {
                await TripService.DeleteTripAsync(tripId);
                await LoadData();
                await JSRuntime.InvokeVoidAsync("showToast", "success", "Trip deleted successfully");
            }
            catch (Exception ex)
            {
                await JSRuntime.InvokeVoidAsync("showToast", "error", $"Error deleting trip: {ex.Message}");
            }
        }
    }

    private async Task ValidateTrip(int tripId)
    {
        try
        {
            await TripService.ValidateTripAsync(tripId);
            await LoadData();
            await JSRuntime.InvokeVoidAsync("showToast", "success", "Trip validated successfully");
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("showToast", "error", $"Error validating trip: {ex.Message}");
        }
    }

    private async Task SuggestTrips()
    {
        try
        {
            tripSuggestions = await TripService.SuggestTripsFromTransactionsAsync();
            
            if (tripSuggestions?.Any() == true)
            {
                showSuggestionsModal = true;
            }
            else
            {
                try
                {
                    await JSRuntime.InvokeVoidAsync("showToast", "info", "No trip suggestions found");
                }
                catch
                {
                    Console.WriteLine("No trip suggestions found");
                }
            }
        }
        catch (Exception ex)
        {
            try
            {
                await JSRuntime.InvokeVoidAsync("showToast", "error", $"Error generating suggestions: {ex.Message}");
            }
            catch
            {
                Console.WriteLine($"Error generating suggestions: {ex.Message}");
            }
        }
    }

    private void CloseSuggestionsModal()
    {
        showSuggestionsModal = false;
        tripSuggestions = null;
    }

    private async Task OnTripsCreated()
    {
        await LoadData();
        CloseSuggestionsModal();
    }

    private void ViewTripDetails(int tripId)
    {
        NavigationManager.NavigateTo($"/trips/{tripId}");
    }

    private void LinkTransactions(int tripId)
    {
        // Find the trip to pass to modal
        var trip = pagedResult.Items.FirstOrDefault(t => t.TripId == tripId);
        if (trip != null)
        {
            linkingTrip = trip;
            showLinkModal = true;
        }
    }

    private void CloseLinkModal()
    {
        showLinkModal = false;
        linkingTrip = null;
    }

    private async Task OnTransactionsLinked()
    {
        await LoadData();
        CloseLinkModal();
    }

    private async Task BulkValidate()
    {
        try
        {
            Console.WriteLine($"BulkValidate called with {selectedTripIds.Count} trips");
            
            var confirmed = await JSRuntime.InvokeAsync<bool>("confirm", 
                $"Are you sure you want to validate {selectedTripIds.Count} selected trips?");
            
            Console.WriteLine($"Confirmation result: {confirmed}");
            
            if (confirmed)
            {
                try
                {
                    foreach (var tripId in selectedTripIds.ToList())
                    {
                        await TripService.ValidateTripAsync(tripId);
                    }
                    
                    await LoadData();
                    ClearSelection();
                    
                    try
                    {
                        await JSRuntime.InvokeVoidAsync("showToast", "success", "Selected trips validated successfully");
                    }
                    catch
                    {
                        Console.WriteLine("Selected trips validated successfully");
                    }
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"Error validating trips: {ex.Message}");
                    try
                    {
                        await JSRuntime.InvokeVoidAsync("showToast", "error", $"Error validating trips: {ex.Message}");
                    }
                    catch
                    {
                        // Fallback
                    }
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"BulkValidate exception: {ex.Message}");
        }
    }

    private async Task BulkExport()
    {
        try
        {
            Console.WriteLine($"BulkExport called with {selectedTripIds.Count} trips");
            
            try
            {
                await JSRuntime.InvokeVoidAsync("showToast", "info", "Export functionality coming soon");
            }
            catch
            {
                Console.WriteLine("Export functionality coming soon");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"BulkExport exception: {ex.Message}");
        }
    }

    private async Task BulkDelete()
    {
        try
        {
            Console.WriteLine($"BulkDelete called with {selectedTripIds.Count} trips");
            
            var confirmed = await JSRuntime.InvokeAsync<bool>("confirm", 
                $"Are you sure you want to delete {selectedTripIds.Count} selected trips? This will unlink all associated transactions.");
            
            Console.WriteLine($"Delete confirmation result: {confirmed}");
            
            if (confirmed)
            {
                try
                {
                    foreach (var tripId in selectedTripIds.ToList())
                    {
                        await TripService.DeleteTripAsync(tripId);
                    }
                    
                    await LoadData();
                    ClearSelection();
                    
                    try
                    {
                        await JSRuntime.InvokeVoidAsync("showToast", "success", "Selected trips deleted successfully");
                    }
                    catch
                    {
                        Console.WriteLine("Selected trips deleted successfully");
                    }
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"Error deleting trips: {ex.Message}");
                    try
                    {
                        await JSRuntime.InvokeVoidAsync("showToast", "error", $"Error deleting trips: {ex.Message}");
                    }
                    catch
                    {
                        // Fallback
                    }
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"BulkDelete exception: {ex.Message}");
        }
    }

    private async Task ExportData()
    {
        // TODO: Implement export functionality
        await JSRuntime.InvokeVoidAsync("showToast", "info", "Export functionality coming soon");
    }
}